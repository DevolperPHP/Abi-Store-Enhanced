import express from 'express'
import fs from 'fs'
import path from 'path'
// @ts-ignore
import gTTS from 'gtts'
// @ts-ignore
import sound from 'sound-play'

class KeyStore {
  private filePath: string
  private store: Record<string, any>

  constructor(fileName = 'store.json') {
    this.filePath = path.resolve(process.cwd(), fileName)
    this.store = this.load()
  }

  private load(): Record<string, any> {
    try {
      if (fs.existsSync(this.filePath)) {
        const data = fs.readFileSync(this.filePath, 'utf-8')
        return JSON.parse(data)
      }
    } catch (err) {
      console.error('Error reading store file:', err)
    }
    return {}
  }

  private save(): void {
    try {
      fs.writeFileSync(this.filePath, JSON.stringify(this.store, null, 2))
    } catch (err) {
      console.error('Error writing store file:', err)
    }
  }

  public set(key: string, value: any): void {
    this.store[key] = value
    this.save()
  }

  public get<T = any>(key: string): T | null {
    return this.store.hasOwnProperty(key) ? this.store[key] : null
  }

  public delete(key: string): void {
    delete this.store[key]
    this.save()
  }

  public has(key: string): boolean {
    return key in this.store
  }

  public getAll(): Record<string, any> {
    return { ...this.store }
  }

  public clear(): void {
    this.store = {}
    this.save()
  }
}

const kv = new KeyStore()
const app = express()
app.use(express.json())

app.get('/', (req, res) => {
  res.send('Hello World!')
})

app.post('/set-timer', (req, res) => {
  const {
    transectionId,
    employeeName,
    serviceName,
  } = req.body

  const currentTime = new Date().valueOf()
  const next30Minutes = currentTime + 30 * 60 * 1000
  const next60Minutes = currentTime + 60 * 60 * 1000
  const next90Minutes = currentTime + 90 * 60 * 1000
  const next120Minutes = currentTime + 120 * 60 * 1000

  kv.set(`${transectionId}-30`, `${next30Minutes}-${employeeName}-${serviceName}`)
  kv.set(`${transectionId}-60`, `${next60Minutes}-${employeeName}-${serviceName}`)
  kv.set(`${transectionId}-90`, `${next90Minutes}-${employeeName}-${serviceName}`)
  kv.set(`${transectionId}-120`, `${next120Minutes}-${employeeName}-${serviceName}`)

  res.json({ done: true })
})

app.post('/delete-timer', (req, res) => {
  const { transectionId } = req.body
  kv.delete(`${transectionId}-30`)
  kv.delete(`${transectionId}-60`)
  kv.delete(`${transectionId}-90`)
  kv.delete(`${transectionId}-120`)
  res.json({ done: true })
})

app.post('/speak', async (req, res) => {
  try {
    const { text } = req.body
    const gtts = new gTTS(text, 'th')
    const outputFile = path.join(path.resolve(), 'output.mp3')
    await new Promise((resolve, reject) => {
      gtts.save(outputFile, (err: any) => {
        if (err) return reject(err)
        resolve(true)
      })
    })

    sound.play(outputFile).then(() => {
      fs.unlink(outputFile, (unlinkErr) => {
        if (unlinkErr) console.error('Error deleting file:', unlinkErr)
      })
    })
    res.json({ done: true })
  } catch (error) {
    console.error('Error generating TTS:', error)
    res.status(500).json({ error: 'Failed to generate speech' })
  }
})

app.listen(3000, () => {
  console.log('app listening on port 3000')
})

const main = () => {
  setInterval(() => {
    const currentTime = new Date().valueOf()
    const times = kv.getAll()
    console.log('currentTime:', currentTime)
    console.log('times:', times)
  }, 10000) // 10 seconds
}

main()
