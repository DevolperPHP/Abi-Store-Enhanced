<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Results</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<%- include("../layout/navbar") -%>

<!-- Comprehensive Analytics Results -->
<div class="analytics-results">
    <!-- Results Header -->
    <div class="results-header">
        <div class="header-content">
            <div class="breadcrumb">
                <a href="/analysis" class="breadcrumb-link">Analytics</a>
                <ion-icon name="chevron-forward-outline" class="breadcrumb-separator"></ion-icon>
                <span class="breadcrumb-current">Analysis Results</span>
            </div>
            <h1 class="results-title">
                <ion-icon name="analytics-outline"></ion-icon>
                <%= analysisType %> Analysis Results
            </h1>
            <p class="results-subtitle">
                Period: <%= startDate %> - <%= endDate %> â€¢ 
                Generated: <%= new Date().toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }) %>
            </p>
        </div>
        <div class="header-actions">
            <button class="btn-secondary" onclick="window.location.href='/analysis'">
                <ion-icon name="arrow-back-outline"></ion-icon>
                New Analysis
            </button>
            <button class="btn-export" onclick="exportResults()">
                <ion-icon name="download-outline"></ion-icon>
                Export to Excel
            </button>
            <button class="btn-print" onclick="printResults()">
                <ion-icon name="print-outline"></ion-icon>
                Print Report
            </button>
        </div>
    </div>

    <!-- Executive Summary -->
    <div class="executive-summary">
        <div class="summary-header">
            <h2 class="summary-title">Executive Summary</h2>
            <div class="summary-period">
                <ion-icon name="calendar-outline"></ion-icon>
                <span><%= startDate %> to <%= endDate %></span>
            </div>
        </div>
        <div class="summary-grid">
            <div class="summary-card sales">
                <div class="summary-icon">
                    <ion-icon name="cart-outline"></ion-icon>
                </div>
                <div class="summary-content">
                    <div class="summary-label">Total Sales</div>
                    <div class="summary-value"><%= (sellTotal || 0).toLocaleString() %> IQD</div>
                    <div class="summary-change <%= (metrics?.revenueChange || 0) >= 0 ? 'positive' : 'negative' %>">
                        <ion-icon name="<%= (metrics?.revenueChange || 0) >= 0 ? 'arrow-up-outline' : 'arrow-down-outline' %>"></ion-icon>
                        <span><%= (metrics?.revenueChange || 0) >= 0 ? '+' : '' %><%= (metrics?.revenueChange || 0).toFixed(1) %>% vs previous period</span>
                    </div>
                </div>
            </div>
            <div class="summary-card purchases">
                <div class="summary-icon">
                    <ion-icon name="cube-outline"></ion-icon>
                </div>
                <div class="summary-content">
                    <div class="summary-label">Total Purchases</div>
                    <div class="summary-value"><%= (purchaseTotal || 0).toLocaleString() %> IQD</div>
                    <div class="summary-change neutral">
                        <ion-icon name="business-outline"></ion-icon>
                        <span>Inventory costs</span>
                    </div>
                </div>
            </div>
            <div class="summary-card daily-transactions">
                <div class="summary-icon">
                    <ion-icon name="wallet-outline"></ion-icon>
                </div>
                <div class="summary-content">
                    <div class="summary-label">Total Daily Transactions</div>
                    <div class="summary-value"><%= (dailyMoneyTotal || 0).toLocaleString() %> IQD</div>
                    <div class="summary-change neutral">
                        <ion-icon name="receipt-outline"></ion-icon>
                        <span>Operating expenses</span>
                    </div>
                </div>
            </div>
            <div class="summary-card calculated-profit">
                <div class="summary-icon">
                    <ion-icon name="cash-outline"></ion-icon>
                </div>
                <div class="summary-content">
                    <div class="summary-label">Profit</div>
                    <div class="summary-value"><%= ((sellTotal || 0) - (purchaseTotal || 0) - (dailyMoneyTotal || 0)).toLocaleString() %> IQD</div>
                    <div class="summary-change <%= ((sellTotal || 0) - (purchaseTotal || 0) - (dailyMoneyTotal || 0)) >= 0 ? 'positive' : 'negative' %>">
                        <ion-icon name="<%= ((sellTotal || 0) - (purchaseTotal || 0) - (dailyMoneyTotal || 0)) >= 0 ? 'arrow-up-outline' : 'arrow-down-outline' %>"></ion-icon>
                        <span>Sales - Purchases - Daily</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Tabs -->
    <div class="analysis-tabs">
        <div class="tab-header">
            <button class="tab-btn active" onclick="switchTab('overview')">
                <ion-icon name="grid-outline"></ion-icon>
                Overview
            </button>
            <button class="tab-btn" onclick="switchTab('sales')">
                <ion-icon name="cart-outline"></ion-icon>
                Sales Analysis
            </button>
            <button class="tab-btn" onclick="switchTab('purchases')">
                <ion-icon name="cube-outline"></ion-icon>
                Purchase Analysis
            </button>
            <button class="tab-btn" onclick="switchTab('inventory')">
                <ion-icon name="library-outline"></ion-icon>
                Inventory Analytics
            </button>
            <button class="tab-btn" onclick="switchTab('dailyMoney')">
                <ion-icon name="wallet-outline"></ion-icon>
                Daily Money Analysis
            </button>
            <button class="tab-btn" onclick="switchTab('trends')">
                <ion-icon name="trending-up-outline"></ion-icon>
                Trends & Forecasting
            </button>
        </div>

        <!-- Overview Tab -->
        <div class="tab-content active" id="overview">
            <div class="overview-grid">
                <!-- Financial Summary -->
                <div class="financial-summary-card">
                    <h3 class="card-title">Financial Performance</h3>
                    <div class="financial-metrics">
                        <div class="metric">
                            <div class="metric-label">Revenue</div>
                            <div class="metric-value revenue"><%= (sellTotal || 0).toLocaleString() %> IQD</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Cost of Goods Sold</div>
                            <div class="metric-value cost"><%= (purchaseTotal || 0).toLocaleString() %> IQD</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Operating Expenses</div>
                            <div class="metric-value expense"><%= (dailyMoneyTotal || 0).toLocaleString() %> IQD</div>
                        </div>
                        <div class="metric total">
                            <div class="metric-label">Net Profit</div>
                            <div class="metric-value profit">
                                <%= ((sellTotal || 0) - (purchaseTotal || 0) - (dailyMoneyTotal || 0)).toLocaleString() %> IQD
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Store Type Comparison -->
                <div class="store-comparison-card">
                    <h3 class="card-title">Store Performance Comparison</h3>
                    <div class="comparison-bars">
                        <div class="comparison-item">
                            <div class="comparison-label">
                                <ion-icon name="storefront-outline"></ion-icon>
                                Local Store
                            </div>
                            <div class="comparison-bar">
                                <div class="comparison-fill local" style="width: <%= (metrics?.localStorePercentage || 0).toFixed(1) %>%"></div>
                            </div>
                            <div class="comparison-value"><%= (metrics?.localStorePercentage || 0).toFixed(1) %>% of total revenue</div>
                        </div>
                        <div class="comparison-item">
                            <div class="comparison-label">
                                <ion-icon name="cube-outline"></ion-icon>
                                Main Storage
                            </div>
                            <div class="comparison-bar">
                                <div class="comparison-fill main" style="width: <%= (metrics?.mainStoragePercentage || 0).toFixed(1) %>%"></div>
                            </div>
                            <div class="comparison-value"><%= (metrics?.mainStoragePercentage || 0).toFixed(1) %>% of total revenue</div>
                        </div>
                    </div>
                </div>

                <!-- Key Performance Indicators -->
                <div class="kpi-card">
                    <h3 class="card-title">Key Performance Indicators</h3>
                    <div class="kpi-grid">
                        <div class="kpi-item">
                            <div class="kpi-value"><%= ((sellTotal || 0) / (sell?.length || 1)).toLocaleString() %> IQD</div>
                            <div class="kpi-label">Avg Transaction Value</div>
                        </div>
                        <div class="kpi-item">
                            <div class="kpi-value"><%= (sell?.length || 0) %></div>
                            <div class="kpi-label">Sales Transactions</div>
                        </div>
                        <div class="kpi-item">
                            <div class="kpi-value"><%= (purchases?.length || 0) %></div>
                            <div class="kpi-label">Purchase Orders</div>
                        </div>
                        <div class="kpi-item">
                            <div class="kpi-value"><%= (metrics?.orderFulfillmentRate || 0).toFixed(1) %>%</div>
                            <div class="kpi-label">Order Fulfillment Rate</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sales Analysis Tab -->
        <div class="tab-content" id="sales">
            <div class="sales-analysis">
                <div class="analysis-section">
                    <h3 class="section-title">Sales Performance</h3>
                    <div class="sales-table-container">
                        <table class="analysis-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Customer</th>
                                    <th>Amount</th>
                                    <th>Store Type</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% if (sell && sell.length > 0) { %>
                                    <% sell.forEach(sale => { %>
                                        <tr>
                                            <td><%= sale.Date %></td>
                                            <td>
                                                <div class="customer-info">
                                                    <div class="customer-name"><%= sale.name || 'Walk-in Customer' %></div>
                                                    <div class="customer-contact"><%= sale.phone || 'N/A' %></div>
                                                </div>
                                            </td>
                                            <td class="amount-cell"><%= (sale.total || 0).toLocaleString() %> IQD</td>
                                            <td>
                                                <span class="store-type <%= sale.isCashier ? 'local' : 'main' %>">
                                                    <ion-icon name="<%= sale.isCashier ? 'storefront-outline' : 'cube-outline' %>"></ion-icon>
                                                    <%= sale.isCashier ? 'Local Store' : 'Main Storage' %>
                                                </span>
                                            </td>
                                            <td>
                                                <button class="action-btn" onclick="viewSaleDetails('<%= sale._id %>')">
                                                    <ion-icon name="eye-outline"></ion-icon>
                                                </button>
                                            </td>
                                        </tr>
                                    <% }) %>
                                <% } else { %>
                                    <tr>
                                        <td colspan="5" class="no-data">No sales data available for the selected period</td>
                                    </tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Purchase Analysis Tab -->
        <div class="tab-content" id="purchases">
            <div class="purchase-analysis">
                <div class="analysis-section">
                    <h3 class="section-title">Purchase Analysis</h3>
                    <div class="purchase-table-container">
                        <table class="analysis-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Trader</th>
                                    <th>Total Amount</th>
                                    <th>Store Type</th>
                                    <th>Items</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% if (purchases && purchases.length > 0) { %>
                                    <% purchases.forEach(purchase => { %>
                                        <tr>
                                            <td><%= purchase.Date %></td>
                                            <td>
                                                <div class="trader-info">
                                                    <div class="trader-name"><%= purchase.trader %></div>
                                                    <div class="trader-details"><%= purchase.user || 'System' %></div>
                                                </div>
                                            </td>
                                            <td class="amount-cell">
                                                <% 
                                                const purchaseTotal = (purchase.purchase || []).reduce((sum, item) => sum + (item.total || 0), 0) + (purchase.cost || 0);
                                                %>
                                                <%= purchaseTotal.toLocaleString() %> IQD
                                            </td>
                                            <td>
                                                <span class="store-type <%= purchase.store ? 'main' : 'local' %>">
                                                    <ion-icon name="<%= purchase.store ? 'cube-outline' : 'storefront-outline' %>"></ion-icon>
                                                    <%= purchase.store ? 'Main Storage' : 'Local Store' %>
                                                </span>
                                            </td>
                                            <td><%= (purchase.purchase || []).length %> items</td>
                                            <td>
                                                <button class="action-btn" onclick="viewPurchaseDetails('<%= purchase._id %>')">
                                                    <ion-icon name="eye-outline"></ion-icon>
                                                </button>
                                            </td>
                                        </tr>
                                    <% }) %>
                                <% } else { %>
                                    <tr>
                                        <td colspan="6" class="no-data">No purchase data available for the selected period</td>
                                    </tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inventory Analytics Tab -->
        <div class="tab-content" id="inventory">
            <div class="inventory-analysis">
                <div class="analysis-section">
                    <h3 class="section-title">Inventory Status</h3>
                    <div class="inventory-grid">
                        <div class="inventory-card">
                            <h4 class="inventory-title">Stock Levels</h4>
                            <div class="inventory-metrics">
                                <div class="inventory-metric">
                                    <span class="metric-label">Total Items</span>
                                    <span class="metric-value"><%= totalItems %></span>
                                </div>
                                <div class="inventory-metric">
                                    <span class="metric-label">Low Stock Items</span>
                                    <span class="metric-value warning">12</span>
                                </div>
                                <div class="inventory-metric">
                                    <span class="metric-label">Out of Stock</span>
                                    <span class="metric-value danger">3</span>
                                </div>
                                <div class="inventory-metric">
                                    <span class="metric-label">Overstocked</span>
                                    <span class="metric-value info">8</span>
                                </div>
                            </div>
                        </div>
                        <div class="inventory-card">
                            <h4 class="inventory-title">Inventory Value</h4>
                            <div class="inventory-value">
                                <div class="value-amount"><%= (purchaseTotal || 0).toLocaleString() %> IQD</div>
                                <div class="value-change positive">
                                    <ion-icon name="arrow-up-outline"></ion-icon>
                                    +5.2% from last month
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Daily Money Analysis Tab -->
        <div class="tab-content" id="dailyMoney">
            <div class="daily-money-analysis">
                <div class="analysis-section">
                    <h3 class="section-title">Daily Money Transactions</h3>
                    <div class="daily-money-table-container">
                        <table class="analysis-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Transaction Items</th>
                                    <th>Total Amount</th>
                                    <th>Store Type</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% if (dailyMoney && dailyMoney.length > 0) { %>
                                    <% dailyMoney.forEach(transaction => { %>
                                        <tr>
                                            <td><%= transaction.Date %></td>
                                            <td>
                                                <div class="transaction-items">
                                                    <% if (transaction.purchase && transaction.purchase.length > 0) { %>
                                                        <div class="items-summary">
                                                            <%= transaction.purchase.length %> item<%= transaction.purchase.length !== 1 ? 's' : '' %>
                                                        </div>
                                                        <div class="items-list">
                                                            <% transaction.purchase.slice(0, 3).forEach(item => { %>
                                                                <div class="item-title"><%= item.title %> - <%= (item.cost || 0).toLocaleString() %> IQD</div>
                                                            <% }) %>
                                                            <% if (transaction.purchase.length > 3) { %>
                                                                <div class="more-items">+<%= transaction.purchase.length - 3 %> more items</div>
                                                            <% } %>
                                                        </div>
                                                    <% } else { %>
                                                        <div class="no-items">No items</div>
                                                    <% } %>
                                                </div>
                                            </td>
                                            <td class="amount-cell"><%= (transaction.total || 0).toLocaleString() %> IQD</td>
                                            <td>
                                                <span class="store-type <%= transaction.isCashier ? 'local' : 'main' %>">
                                                    <ion-icon name="<%= transaction.isCashier ? 'storefront-outline' : 'wallet-outline' %>"></ion-icon>
                                                    <%= transaction.isCashier ? 'Local Store' : 'Daily Money' %>
                                                </span>
                                            </td>
                                            <td>
                                                <button class="action-btn" onclick="viewDailyMoneyDetails('<%= transaction._id %>')">
                                                    <ion-icon name="eye-outline"></ion-icon>
                                                </button>
                                            </td>
                                        </tr>
                                    <% }) %>
                                <% } else { %>
                                    <tr>
                                        <td colspan="5" class="no-data">No daily money data available for the selected period</td>
                                    </tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trends Tab -->
        <div class="tab-content" id="trends">
            <div class="trends-analysis">
                <div class="analysis-section">
                    <h3 class="section-title">Business Trends & Performance</h3>
                    <div class="trends-content">
                        <div class="trend-chart-container">
                            <div class="chart-controls">
                                <select id="chartType" onchange="updateChart()" class="chart-selector">
                                    <option value="revenue">Revenue Trend</option>
                                    <option value="profit">Profit Trend</option>
                                    <option value="comparison">Revenue vs Costs</option>
                                </select>
                                <div class="chart-legend">
                                    <div class="legend-item">
                                        <span class="legend-color" style="background: #007AFF"></span>
                                        <span>Revenue</span>
                                    </div>
                                    <div class="legend-item">
                                        <span class="legend-color" style="background: #34C759"></span>
                                        <span>Profit</span>
                                    </div>
                                    <div class="legend-item">
                                        <span class="legend-color" style="background: #FF9500"></span>
                                        <span>Costs</span>
                                    </div>
                                </div>
                            </div>
                            <canvas id="trendsChart" width="400" height="200"></canvas>
                        </div>
                        <div class="trend-insights">
                            <div class="insight-card">
                                <h4>
                                    <ion-icon name="trending-up-outline"></ion-icon>
                                    Growth Opportunities
                                </h4>
                                <ul id="growthOpportunities">
                                    <% if (trendsData && trendsData.insights && trendsData.insights.growthOpportunities) { %>
                                        <% trendsData.insights.growthOpportunities.forEach(opportunity => { %>
                                            <li><%= opportunity %></li>
                                        <% }) %>
                                    <% } else { %>
                                        <li>Analyzing data for growth opportunities...</li>
                                    <% } %>
                                </ul>
                            </div>
                            <div class="insight-card warning">
                                <h4>
                                    <ion-icon name="warning-outline"></ion-icon>
                                    Areas for Improvement
                                </h4>
                                <ul id="areasForImprovement">
                                    <% if (trendsData && trendsData.insights && trendsData.insights.areasForImprovement) { %>
                                        <% trendsData.insights.areasForImprovement.forEach(area => { %>
                                            <li><%= area %></li>
                                        <% }) %>
                                    <% } else { %>
                                        <li>No immediate areas of concern identified</li>
                                    <% } %>
                                </ul>
                            </div>
                            <% if (trendsData && trendsData.insights && trendsData.insights.keyMetrics) { %>
                            <div class="insight-card metrics">
                                <h4>
                                    <ion-icon name="analytics-outline"></ion-icon>
                                    Key Metrics
                                </h4>
                                <div class="metrics-grid">
                                    <div class="metric-item">
                                        <div class="metric-value"><%= (trendsData.insights.keyMetrics.totalRevenue || 0).toLocaleString() %> IQD</div>
                                        <div class="metric-label">Total Revenue</div>
                                    </div>
                                    <div class="metric-item">
                                        <div class="metric-value"><%= (trendsData.insights.keyMetrics.avgDailyRevenue || 0).toLocaleString() %> IQD</div>
                                        <div class="metric-label">Daily Average</div>
                                    </div>
                                    <div class="metric-item">
                                        <div class="metric-value"><%= (trendsData.insights.revenueGrowth || 0).toFixed(1) %>%</div>
                                        <div class="metric-label">Growth Rate</div>
                                    </div>
                                    <div class="metric-item">
                                        <div class="metric-value"><%= trendsData.insights.keyMetrics.totalDays || 0 %></div>
                                        <div class="metric-label">Days Analyzed</div>
                                    </div>
                                </div>
                            </div>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* ===== ANALYTICS RESULTS ===== */
    .analytics-results {
        max-width: 1400px;
        margin: 0 auto;
        padding: 40px 20px;
        margin-left: 260px;
        margin-top: 40px;
    }

    /* ===== RESULTS HEADER ===== */
    .results-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 32px;
        padding: 24px;
        background: #ffffff;
        border-radius: 16px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        border: 1px solid rgba(0, 0, 0, 0.06);
    }

    .breadcrumb {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
    }

    .breadcrumb-link {
        color: #007AFF;
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
    }

    .breadcrumb-link:hover {
        text-decoration: underline;
    }

    .breadcrumb-separator {
        font-size: 14px;
        color: #8e8e93;
    }

    .breadcrumb-current {
        font-size: 14px;
        color: #8e8e93;
        font-weight: 500;
    }

    .results-title {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 28px;
        font-weight: 700;
        color: #1d1d1f;
        margin: 0 0 8px 0;
        letter-spacing: -0.5px;
    }

    .results-title ion-icon {
        font-size: 32px;
        color: #007AFF;
    }

    .results-subtitle {
        font-size: 16px;
        color: #8e8e93;
        margin: 0;
        font-weight: 400;
    }

    .header-actions {
        display: flex;
        gap: 12px;
    }

    .btn-secondary,
    .btn-export,
    .btn-print {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 16px;
        border: none;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        text-decoration: none;
    }

    .btn-secondary {
        background: rgba(0, 0, 0, 0.04);
        color: #1d1d1f;
    }

    .btn-export {
        background: #007AFF;
        color: #ffffff;
    }

    .btn-print {
        background: rgba(0, 122, 255, 0.1);
        color: #007AFF;
    }

    .btn-secondary:hover {
        background: rgba(0, 0, 0, 0.08);
    }

    .btn-export:hover {
        background: #0056b3;
    }

    .btn-print:hover {
        background: rgba(0, 122, 255, 0.15);
    }

    .btn-secondary ion-icon,
    .btn-export ion-icon,
    .btn-print ion-icon {
        font-size: 16px;
    }

    /* ===== EXECUTIVE SUMMARY ===== */
    .executive-summary {
        background: #ffffff;
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        border: 1px solid rgba(0, 0, 0, 0.06);
    }

    .summary-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .summary-title {
        font-size: 20px;
        font-weight: 600;
        color: #1d1d1f;
        margin: 0;
    }

    .summary-period {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: #8e8e93;
        background: #f8f9fa;
        padding: 8px 12px;
        border-radius: 8px;
    }

    .summary-period ion-icon {
        font-size: 16px;
    }

    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
    }

    .summary-card {
        border: 1px solid #f0f0f0;
        border-radius: 12px;
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 16px;
        transition: transform 0.2s ease;
    }

    .summary-card:hover {
        transform: translateY(-2px);
    }

    .summary-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .summary-card.sales .summary-icon {
        background: rgba(52, 199, 89, 0.1);
        color: #34C759;
    }

    .summary-card.purchases .summary-icon {
        background: rgba(255, 149, 0, 0.1);
        color: #FF9500;
    }

    .summary-card.daily-transactions .summary-icon {
        background: rgba(0, 122, 255, 0.1);
        color: #007AFF;
    }

    .summary-card.calculated-profit .summary-icon {
        background: rgba(88, 86, 214, 0.1);
        color: #5856D6;
    }

    .summary-icon ion-icon {
        font-size: 24px;
    }

    .summary-content {
        flex: 1;
    }

    .summary-label {
        font-size: 14px;
        color: #8e8e93;
        margin-bottom: 4px;
        font-weight: 500;
    }

    .summary-value {
        font-size: 22px;
        font-weight: 700;
        color: #1d1d1f;
        margin-bottom: 4px;
    }

    .summary-change {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 12px;
        font-weight: 600;
    }

    .summary-change.positive {
        color: #34C759;
    }

    .summary-change.negative {
        color: #FF3B30;
    }

    .summary-change.neutral {
        color: #8e8e93;
    }

    .summary-change ion-icon {
        font-size: 14px;
    }

    /* ===== ANALYSIS TABS ===== */
    .analysis-tabs {
        background: #ffffff;
        border-radius: 16px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        border: 1px solid rgba(0, 0, 0, 0.06);
        overflow: hidden;
    }

    .tab-header {
        display: flex;
        border-bottom: 1px solid #f0f0f0;
        overflow-x: auto;
    }

    .tab-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 16px 20px;
        background: none;
        border: none;
        color: #8e8e93;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        white-space: nowrap;
        border-bottom: 2px solid transparent;
    }

    .tab-btn:hover {
        color: #1d1d1f;
        background: rgba(0, 0, 0, 0.02);
    }

    .tab-btn.active {
        color: #007AFF;
        border-bottom-color: #007AFF;
        background: rgba(0, 122, 255, 0.05);
    }

    .tab-btn ion-icon {
        font-size: 16px;
    }

    .tab-content {
        display: none;
        padding: 24px;
    }

    .tab-content.active {
        display: block;
    }

    /* ===== OVERVIEW TAB ===== */
    .overview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 20px;
    }

    .financial-summary-card,
    .store-comparison-card,
    .kpi-card {
        border: 1px solid #f0f0f0;
        border-radius: 12px;
        padding: 20px;
    }

    .card-title {
        font-size: 16px;
        font-weight: 600;
        color: #1d1d1f;
        margin: 0 0 16px 0;
    }

    .financial-metrics {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .metric {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
    }

    .metric.total {
        border-top: 1px solid #f0f0f0;
        margin-top: 8px;
        padding-top: 12px;
    }

    .metric-label {
        font-size: 14px;
        color: #8e8e93;
    }

    .metric-value {
        font-size: 16px;
        font-weight: 600;
    }

    .metric-value.revenue {
        color: #34C759;
    }

    .metric-value.cost {
        color: #FF9500;
    }

    .metric-value.expense {
        color: #FF3B30;
    }

    .metric-value.profit {
        color: #007AFF;
    }

    .comparison-bars {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .comparison-item {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .comparison-label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        font-weight: 500;
        color: #1d1d1f;
    }

    .comparison-label ion-icon {
        font-size: 16px;
    }

    .comparison-bar {
        width: 100%;
        height: 8px;
        background: #f0f0f0;
        border-radius: 4px;
        overflow: hidden;
    }

    .comparison-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.5s ease;
    }

    .comparison-fill.local {
        background: linear-gradient(90deg, #007AFF, #5856D6);
    }

    .comparison-fill.main {
        background: linear-gradient(90deg, #34C759, #30d158);
    }

    .comparison-value {
        font-size: 12px;
        color: #8e8e93;
        text-align: right;
    }

    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 16px;
    }

    .kpi-item {
        text-align: center;
        padding: 16px;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .kpi-value {
        font-size: 20px;
        font-weight: 700;
        color: #1d1d1f;
        margin-bottom: 4px;
    }

    .kpi-label {
        font-size: 12px;
        color: #8e8e93;
        font-weight: 500;
    }

    /* ===== TABLES ===== */
    .analysis-section {
        margin-bottom: 32px;
    }

    .section-title {
        font-size: 18px;
        font-weight: 600;
        color: #1d1d1f;
        margin: 0 0 20px 0;
    }

    .sales-table-container,
    .purchase-table-container {
        border-radius: 12px;
        border: 1px solid #f0f0f0;
        overflow: hidden;
    }

    .analysis-table {
        width: 100%;
        border-collapse: collapse;
        background: #ffffff;
    }

    .analysis-table th {
        background: #f8f9fa;
        padding: 16px 12px;
        text-align: left;
        font-size: 13px;
        font-weight: 600;
        color: #8e8e93;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 1px solid #f0f0f0;
    }

    .analysis-table td {
        border-bottom: 1px solid #f5f5f5;
        vertical-align: middle;
        padding: 16px 12px;
    }

    .analysis-table tr:hover {
        background: #f8f9fa;
    }

    .customer-info,
    .trader-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .customer-name,
    .trader-name {
        font-size: 14px;
        font-weight: 600;
        color: #1d1d1f;
    }

    .customer-contact,
    .trader-details {
        font-size: 12px;
        color: #8e8e93;
    }

    .amount-cell {
        font-weight: 600;
        color: #007AFF;
    }

    .store-type {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 8px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 500;
    }

    .store-type.local {
        background: rgba(0, 122, 255, 0.1);
        color: #007AFF;
    }

    .store-type.main {
        background: rgba(52, 199, 89, 0.1);
        color: #34C759;
    }

    .store-type ion-icon {
        font-size: 14px;
    }

    .action-btn {
        width: 32px;
        height: 32px;
        border: none;
        border-radius: 6px;
        background: rgba(0, 122, 255, 0.1);
        color: #007AFF;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .action-btn:hover {
        background: rgba(0, 122, 255, 0.15);
    }

    .action-btn ion-icon {
        font-size: 14px;
    }

    .no-data {
        text-align: center;
        color: #8e8e93;
        font-style: italic;
        padding: 40px 20px;
    }

    /* Daily Money Analysis Styles */
    .daily-money-analysis {
        margin-bottom: 32px;
    }

    .daily-money-table-container {
        border-radius: 12px;
        border: 1px solid #f0f0f0;
        overflow: hidden;
    }

    .transaction-items {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .items-summary {
        font-size: 13px;
        font-weight: 600;
        color: #007AFF;
        margin-bottom: 2px;
    }

    .items-list {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .item-title {
        font-size: 12px;
        color: #1d1d1f;
        line-height: 1.3;
    }

    .more-items {
        font-size: 11px;
        color: #8e8e93;
        font-style: italic;
    }

    .no-items {
        font-size: 12px;
        color: #8e8e93;
        font-style: italic;
    }

    /* ===== INVENTORY ANALYSIS ===== */
    .inventory-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    .inventory-card {
        border: 1px solid #f0f0f0;
        border-radius: 12px;
        padding: 20px;
    }

    .inventory-title {
        font-size: 16px;
        font-weight: 600;
        color: #1d1d1f;
        margin: 0 0 16px 0;
    }

    .inventory-metrics {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .inventory-metric {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
    }

    .inventory-metric .metric-label {
        font-size: 14px;
        color: #8e8e93;
    }

    .inventory-metric .metric-value {
        font-size: 16px;
        font-weight: 600;
    }

    .metric-value.warning {
        color: #FF9500;
    }

    .metric-value.danger {
        color: #FF3B30;
    }

    .metric-value.info {
        color: #007AFF;
    }

    .inventory-value {
        text-align: center;
    }

    .value-amount {
        font-size: 32px;
        font-weight: 700;
        color: #1d1d1f;
        margin-bottom: 8px;
    }

    .value-change {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        font-size: 14px;
        font-weight: 500;
    }

    .value-change.positive {
        color: #34C759;
    }

    .value-change.negative {
        color: #FF3B30;
    }

    .value-change ion-icon {
        font-size: 16px;
    }

    /* ===== TRENDS ANALYSIS ===== */
    .trends-placeholder {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
    }

    .trend-chart {
        border: 1px solid #f0f0f0;
        border-radius: 12px;
        padding: 20px;
        min-height: 300px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .chart-placeholder {
        text-align: center;
        color: #8e8e93;
    }

    .chart-placeholder ion-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
    }

    .chart-placeholder p {
        font-size: 16px;
        font-weight: 600;
        margin: 0 0 8px 0;
    }

    .chart-placeholder small {
        font-size: 14px;
    }

    .trend-insights {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .insight-card {
        border: 1px solid #f0f0f0;
        border-radius: 12px;
        padding: 16px;
    }

    .insight-card.warning {
        border-color: rgba(255, 149, 0, 0.3);
        background: rgba(255, 149, 0, 0.05);
    }

    .insight-card h4 {
        font-size: 14px;
        font-weight: 600;
        color: #1d1d1f;
        margin: 0 0 12px 0;
    }

    .insight-card ul {
        margin: 0;
        padding-left: 16px;
    }

    .insight-card li {
        font-size: 13px;
        color: #8e8e93;
        margin-bottom: 6px;
        line-height: 1.4;
    }

    /* ===== RESPONSIVE DESIGN ===== */
    @media (max-width: 1024px) {
        .analytics-results {
            padding: 20px 16px;
        }

        .results-header {
            flex-direction: column;
            gap: 16px;
        }

        .summary-grid {
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        }

        .overview-grid {
            grid-template-columns: 1fr;
        }

        .trends-placeholder {
            grid-template-columns: 1fr;
        }

        .tab-header {
            justify-content: flex-start;
        }
    }

    @media (max-width: 768px) {
        .results-title {
            font-size: 22px;
        }

        .summary-grid {
            grid-template-columns: 1fr;
        }

        .analysis-table {
            font-size: 14px;
        }

        .analysis-table th,
        .analysis-table td {
            padding: 12px 8px;
        }

        .inventory-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<script>
    let currentTab = 'overview';
    let trendsChart = null;

    function switchTab(tabName) {
        // Update active tab button
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');

        // Update active tab content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(tabName).classList.add('active');

        currentTab = tabName;
        
        // Initialize chart when trends tab is opened
        if (tabName === 'trends' && !trendsChart) {
            initializeChart();
        }
    }

    function exportResults() {
        // Get the current date range and analysis type
        const startDate = '<%= startDate %>'.replace(/\//g, '-');
        const endDate = '<%= endDate %>'.replace(/\//g, '-');
        const analysisType = '<%= analysisType.toLowerCase() %>';
        
        // Create download URL
        const exportUrl = `/analysis/export/${startDate}/${endDate}?type=${analysisType}`;
        
        // Open in new tab for download
        window.open(exportUrl, '_blank');
    }

    function printResults() {
        // Show print loading indicator
        const originalContent = document.body.innerHTML;
        const loadingHTML = `
            <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                        background: rgba(255,255,255,0.95); display: flex;
                        align-items: center; justify-content: center; z-index: 9999;">
                <div style="text-align: center;">
                    <div style="width: 40px; height: 40px; border: 4px solid #f0f0f0;
                                border-top: 4px solid #007AFF; border-radius: 50%;
                                animation: spin 1s linear infinite; margin: 0 auto 16px;"></div>
                    <div style="color: #1d1d1f; font-size: 16px; font-weight: 600;">Generating Professional Report...</div>
                </div>
            </div>
            <style>
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            </style>
        `;
        document.body.insertAdjacentHTML('afterbegin', loadingHTML);
        
        setTimeout(() => {
            generatePrintReport();
        }, 1500);
    }
    
    function generatePrintReport() {
        // Create print-specific window
        const printWindow = window.open('', '_blank');
        
        // Get current analysis data
        const analysisData = {
            analysisType: '<%= analysisType %>',
            startDate: '<%= startDate %>',
            endDate: '<%= endDate %>',
            sellTotal: <%= sellTotal || 0 %>,
            purchaseTotal: <%= purchaseTotal || 0 %>,
            dailyMoneyTotal: <%= dailyMoneyTotal || 0 %>,
            netProfit: <%= (sellTotal || 0) - (purchaseTotal || 0) - (dailyMoneyTotal || 0) %>,
            totalTransactions: <%= ((sell?.length || 0) + (purchases?.length || 0) + (dailyMoney?.length || 0)) %>,
            salesData: <%- JSON.stringify(sell || []) %>,
            purchasesData: <%- JSON.stringify(purchases || []) %>,
            dailyMoneyData: <%- JSON.stringify(dailyMoney || []) %>,
            metrics: <%- JSON.stringify(metrics || {}) %>
        };
        
        const printHTML = createPrintReportHTML(analysisData);
        printWindow.document.write(printHTML);
        printWindow.document.close();
        
        // Print after content loads
        printWindow.onload = function() {
            printWindow.print();
            printWindow.onafterprint = function() {
                printWindow.close();
            };
        };
    }
    
    function createPrintReportHTML(data) {
        return `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Analysis Report - ${data.analysisType}</title>
    <style>
        /* Professional Print Styles */
        @page {
            size: A4;
            margin: 0.75in;
            @top-center {
                content: "Business Analysis Report";
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                font-size: 10px;
                color: #8e8e93;
                border-bottom: 1px solid #e5e5e7;
                padding-bottom: 8px;
            }
            @bottom-center {
                content: "Page " counter(page) " of " counter(pages);
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                font-size: 10px;
                color: #8e8e93;
            }
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #1d1d1f;
            background: #ffffff;
            margin: 0;
            padding: 0;
        }
        
        /* Company Header */
        .company-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 32px;
            padding-bottom: 20px;
            border-bottom: 2px solid #007AFF;
        }
        
        .company-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .company-logo {
            width: 48px;
            height: 48px;
            background: #007AFF;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ffffff;
            font-size: 24px;
            font-weight: 700;
        }
        
        .company-details {
            display: flex;
            flex-direction: column;
        }
        
        .company-name {
            font-size: 24px;
            font-weight: 700;
            color: #1d1d1f;
            margin: 0;
            letter-spacing: -0.5px;
        }
        
        .company-tagline {
            font-size: 14px;
            color: #8e8e93;
            margin: 0;
        }
        
        .report-date {
            text-align: right;
            font-size: 14px;
            color: #8e8e93;
        }
        
        .report-date strong {
            color: #1d1d1f;
        }
        
        /* Report Title */
        .report-title-section {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .report-main-title {
            font-size: 32px;
            font-weight: 700;
            color: #1d1d1f;
            margin: 0 0 12px 0;
            letter-spacing: -0.5px;
        }
        
        .report-subtitle {
            font-size: 18px;
            color: #8e8e93;
            margin: 0 0 16px 0;
            font-weight: 400;
        }
        
        .report-period {
            font-size: 16px;
            color: #1d1d1f;
            font-weight: 500;
            background: #f8f9fa;
            padding: 8px 16px;
            border-radius: 6px;
            display: inline-block;
        }
        
        /* Executive Summary Cards */
        .executive-summary {
            margin-bottom: 40px;
            page-break-inside: avoid;
        }
        
        .summary-title {
            font-size: 24px;
            font-weight: 600;
            color: #1d1d1f;
            margin: 0 0 20px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #e5e5e7;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .summary-card {
            border: 1px solid #e5e5e7;
            border-radius: 8px;
            padding: 24px;
            background: #ffffff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .summary-card.sales { border-left: 4px solid #34C759; }
        .summary-card.purchases { border-left: 4px solid #FF9500; }
        .summary-card.daily { border-left: 4px solid #007AFF; }
        .summary-card.profit { border-left: 4px solid #5856D6; }
        
        .summary-label {
            font-size: 14px;
            color: #8e8e93;
            margin-bottom: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .summary-value {
            font-size: 32px;
            font-weight: 700;
            color: #1d1d1f;
            margin-bottom: 8px;
            line-height: 1.2;
        }
        
        .summary-change {
            font-size: 13px;
            color: #8e8e93;
            font-style: italic;
        }
        
        /* Sections */
        .report-section {
            margin-bottom: 40px;
            page-break-inside: avoid;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #1d1d1f;
            margin: 0 0 16px 0;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e5e7;
        }
        
        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 13px;
            border: 1px solid #e5e5e7;
        }
        
        .data-table th {
            background: #f8f9fa;
            color: #1d1d1f;
            font-weight: 600;
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #e5e5e7;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .data-table td {
            padding: 12px 8px;
            border-bottom: 1px solid #f5f5f7;
            vertical-align: top;
        }
        
        .data-table tbody tr:nth-child(even) {
            background: #fafafa;
        }
        
        .data-table tbody tr:hover {
            background: #f0f9ff;
        }
        
        .amount {
            font-weight: 600;
            color: #007AFF;
        }
        
        .store-type {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            border: 1px solid;
        }
        
        .store-local {
            background: rgba(0, 122, 255, 0.1);
            color: #007AFF;
            border-color: #007AFF;
        }
        
        .store-main {
            background: rgba(52, 199, 89, 0.1);
            color: #34C759;
            border-color: #34C759;
        }
        
        /* Key Metrics */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .metric-item {
            text-align: center;
            padding: 20px;
            background: #ffffff;
            border: 1px solid #e5e5e7;
            border-radius: 8px;
        }
        
        .metric-value {
            font-size: 28px;
            font-weight: 700;
            color: #1d1d1f;
            margin-bottom: 8px;
        }
        
        .metric-label {
            font-size: 13px;
            color: #8e8e93;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Footer */
        .report-footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #e5e5e7;
            text-align: center;
            color: #8e8e93;
            font-size: 12px;
        }
        
        .confidential-notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 12px;
            margin-top: 16px;
            text-align: center;
            color: #856404;
            font-weight: 500;
        }
        
        /* Print Optimizations */
        @media print {
            .company-header {
                margin-bottom: 24px;
            }
            
            .summary-grid {
                gap: 16px;
            }
            
            .summary-card {
                padding: 20px;
            }
            
            .data-table {
                font-size: 12px;
            }
            
            .data-table th,
            .data-table td {
                padding: 8px 6px;
            }
        }
    </style>
</head>
<body>
    <!-- Company Header -->
    <div class="company-header">
        <div class="company-info">
            <div class="company-logo">BA</div>
            <div class="company-details">
                <h1 class="company-name">Business Analytics System</h1>
                <p class="company-tagline">Comprehensive Business Intelligence & Reporting</p>
            </div>
        </div>
        <div class="report-date">
            <div><strong>Report Generated:</strong></div>
            <div>${new Date().toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            })}</div>
            <div>${new Date().toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit'
            })}</div>
        </div>
    </div>

    <!-- Report Title -->
    <div class="report-title-section">
        <h1 class="report-main-title">Business Analysis Report</h1>
        <p class="report-subtitle">${data.analysisType} Performance Analysis</p>
        <div class="report-period">Analysis Period: ${data.startDate} - ${data.endDate}</div>
    </div>

    <!-- Executive Summary -->
    <div class="executive-summary">
        <h2 class="summary-title">Executive Summary</h2>
        <div class="summary-grid">
            <div class="summary-card sales">
                <div class="summary-label">Total Sales Revenue</div>
                <div class="summary-value">${data.sellTotal.toLocaleString()} IQD</div>
                <div class="summary-change">Revenue generated from all sales transactions</div>
            </div>
            <div class="summary-card purchases">
                <div class="summary-label">Total Purchase Costs</div>
                <div class="summary-value">${data.purchaseTotal.toLocaleString()} IQD</div>
                <div class="summary-change">Inventory and operational procurement costs</div>
            </div>
            <div class="summary-card daily">
                <div class="summary-label">Daily Operating Expenses</div>
                <div class="summary-value">${data.dailyMoneyTotal.toLocaleString()} IQD</div>
                <div class="summary-change">Daily operational and administrative expenses</div>
            </div>
            <div class="summary-card profit">
                <div class="summary-label">Net Profit</div>
                <div class="summary-value">${data.netProfit.toLocaleString()} IQD</div>
                <div class="summary-change">Net profit calculation: Sales - Purchases - Daily Expenses</div>
            </div>
        </div>
    </div>

    <!-- Key Performance Indicators -->
    <div class="report-section">
        <h2 class="section-title">Key Performance Indicators</h2>
        <div class="metrics-grid">
            <div class="metric-item">
                <div class="metric-value">${data.totalTransactions}</div>
                <div class="metric-label">Total Transactions</div>
            </div>
            <div class="metric-item">
                <div class="metric-value">${data.metrics?.profitMargin?.toFixed(1) || 0}%</div>
                <div class="metric-label">Profit Margin</div>
            </div>
            <div class="metric-item">
                <div class="metric-value">${data.sellTotal > 0 ? Math.round(data.sellTotal / (data.salesData?.length || 1)).toLocaleString() : 0}</div>
                <div class="metric-label">Average Transaction Value</div>
            </div>
        </div>
    </div>

    <!-- Sales Analysis -->
    ${data.salesData && data.salesData.length > 0 ? `
    <div class="report-section">
        <h2 class="section-title">Sales Transactions Analysis (${data.salesData.length} records)</h2>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Transaction Date</th>
                    <th>Customer Name</th>
                    <th>Transaction Amount</th>
                    <th>Store Location</th>
                </tr>
            </thead>
            <tbody>
                ${data.salesData.slice(0, 20).map(sale => `
                    <tr>
                        <td>${sale.Date || 'N/A'}</td>
                        <td>${sale.name || 'Walk-in Customer'}</td>
                        <td class="amount">${(sale.total || 0).toLocaleString()} IQD</td>
                        <td><span class="store-type ${sale.isCashier ? 'store-local' : 'store-main'}">${sale.isCashier ? 'Local Store' : 'Main Storage'}</span></td>
                    </tr>
                `).join('')}
                ${data.salesData.length > 20 ? `
                    <tr>
                        <td colspan="4" style="text-align: center; color: #8e8e93; font-style: italic; padding: 16px;">
                            Additional ${data.salesData.length - 20} sales transactions not displayed for brevity
                        </td>
                    </tr>
                ` : ''}
            </tbody>
        </table>
    </div>
    ` : ''}

    <!-- Purchase Analysis -->
    ${data.purchasesData && data.purchasesData.length > 0 ? `
    <div class="report-section">
        <h2 class="section-title">Purchase Transactions Analysis (${data.purchasesData.length} records)</h2>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Purchase Date</th>
                    <th>Supplier/Trader</th>
                    <th>Total Purchase Amount</th>
                    <th>Storage Location</th>
                    <th>Items Quantity</th>
                </tr>
            </thead>
            <tbody>
                ${data.purchasesData.slice(0, 20).map(purchase => {
                    const purchaseTotal = (purchase.purchase || []).reduce((sum, item) => sum + (parseFloat(item.total) || 0), 0) + (parseFloat(purchase.cost) || 0);
                    return `
                    <tr>
                        <td>${purchase.Date || 'N/A'}</td>
                        <td>${purchase.trader || 'Unknown Trader'}</td>
                        <td class="amount">${purchaseTotal.toLocaleString()} IQD</td>
                        <td><span class="store-type ${purchase.store ? 'store-main' : 'store-local'}">${purchase.store ? 'Main Storage' : 'Local Store'}</span></td>
                        <td>${(purchase.purchase || []).length} items</td>
                    </tr>
                    `;
                }).join('')}
                ${data.purchasesData.length > 20 ? `
                    <tr>
                        <td colspan="5" style="text-align: center; color: #8e8e93; font-style: italic; padding: 16px;">
                            Additional ${data.purchasesData.length - 20} purchase transactions not displayed for brevity
                        </td>
                    </tr>
                ` : ''}
            </tbody>
        </table>
    </div>
    ` : ''}

    <!-- Daily Money Analysis -->
    ${data.dailyMoneyData && data.dailyMoneyData.length > 0 ? `
    <div class="report-section">
        <h2 class="section-title">Daily Operating Expenses Analysis (${data.dailyMoneyData.length} entries)</h2>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Expense Date</th>
                    <th>Total Daily Amount</th>
                    <th>Number of Transactions</th>
                </tr>
            </thead>
            <tbody>
                ${(() => {
                    const grouped = data.dailyMoneyData.reduce((acc, day) => {
                        const date = day.Date;
                        if (!acc[date]) acc[date] = { date, total: 0, count: 0 };
                        acc[date].total += parseFloat(day.total) || 0;
                        acc[date].count += 1;
                        return acc;
                    }, {});
                    
                    return Object.entries(grouped).slice(0, 20).map(([date, info]) => `
                        <tr>
                            <td>${date}</td>
                            <td class="amount">${info.total.toLocaleString()} IQD</td>
                            <td>${info.count}</td>
                        </tr>
                    `).join('');
                })()}
                ${Object.keys(data.dailyMoneyData.reduce((acc, day) => {
                    const date = day.Date;
                    if (!acc[date]) acc[date] = true;
                    return acc;
                }, {})).length > 20 ? `
                    <tr>
                        <td colspan="3" style="text-align: center; color: #8e8e93; font-style: italic; padding: 16px;">
                            Additional daily expense entries not displayed for brevity
                        </td>
                    </tr>
                ` : ''}
            </tbody>
        </table>
    </div>
    ` : ''}

    <!-- Report Footer -->
    <div class="report-footer">
        <p><strong>Business Analytics System</strong> â€¢ Professional Business Intelligence & Reporting Platform</p>
        <p>This report contains confidential business information and proprietary data.</p>
        <div class="confidential-notice">
            CONFIDENTIAL BUSINESS DOCUMENT - Handle according to company data protection policies
        </div>
    </div>
</body>
</html>
        `;
    }

    function viewSaleDetails(saleId) {
        window.location.href = `/sell/get-data/${saleId}`;
    }

    function viewPurchaseDetails(purchaseId) {
        window.location.href = `/purchase/get-purchase/${purchaseId}`;
    }

    function viewDailyMoneyDetails(dailyMoneyId) {
        window.location.href = `/dailymoney/get/${dailyMoneyId}`;
    }

    // Chart functionality
    function initializeChart() {
        const ctx = document.getElementById('trendsChart').getContext('2d');
        
        // Get trends data from server
        const trendsData = <%- JSON.stringify(trendsData || { dailyData: [], insights: {} }) %>;
        
        if (trendsData.dailyData && trendsData.dailyData.length > 0) {
            createChart(ctx, trendsData.dailyData, 'revenue');
        } else {
            // Show placeholder if no data
            ctx.font = '16px Arial';
            ctx.fillStyle = '#8e8e93';
            ctx.textAlign = 'center';
            ctx.fillText('No trend data available for the selected period', 200, 100);
        }
    }

    function createChart(ctx, data, chartType) {
        const labels = data.map(day => day.date);
        const revenueData = data.map(day => day.sales);
        const profitData = data.map(day => day.profit);
        const costData = data.map(day => day.purchases + day.dailyMoney);
        
        let datasets = [];
        
        switch(chartType) {
            case 'revenue':
                datasets = [{
                    label: 'Revenue',
                    data: revenueData,
                    borderColor: '#007AFF',
                    backgroundColor: 'rgba(0, 122, 255, 0.1)',
                    fill: true,
                    tension: 0.4
                }];
                break;
            case 'profit':
                datasets = [{
                    label: 'Profit',
                    data: profitData,
                    borderColor: '#34C759',
                    backgroundColor: 'rgba(52, 199, 89, 0.1)',
                    fill: true,
                    tension: 0.4
                }];
                break;
            case 'comparison':
                datasets = [
                    {
                        label: 'Revenue',
                        data: revenueData,
                        borderColor: '#007AFF',
                        backgroundColor: 'rgba(0, 122, 255, 0.1)',
                        fill: false,
                        tension: 0.4
                    },
                    {
                        label: 'Costs',
                        data: costData,
                        borderColor: '#FF9500',
                        backgroundColor: 'rgba(255, 149, 0, 0.1)',
                        fill: false,
                        tension: 0.4
                    }
                ];
                break;
        }
        
        trendsChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + ' IQD';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString() + ' IQD';
                            }
                        }
                    },
                    x: {
                        ticks: {
                            maxTicksLimit: 10
                        }
                    }
                }
            }
        });
    }

    function updateChart() {
        const chartType = document.getElementById('chartType').value;
        const trendsData = <%- JSON.stringify(trendsData || { dailyData: [], insights: {} }) %>;
        
        if (trendsChart && trendsData.dailyData) {
            trendsChart.destroy();
            const ctx = document.getElementById('trendsChart').getContext('2d');
            createChart(ctx, trendsData.dailyData, chartType);
        }
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize chart if trends tab is active on load
        if (currentTab === 'trends') {
            initializeChart();
        }
    });
</script>

<style>
    /* Additional styles for the new chart layout */
    .trends-content {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 24px;
        align-items: start;
    }
    
    .trend-chart-container {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        border: 1px solid #f0f0f0;
    }
    
    .chart-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }
    
    .chart-selector {
        padding: 8px 12px;
        border: 1px solid #f0f0f0;
        border-radius: 6px;
        background: #ffffff;
        font-size: 14px;
        color: #1d1d1f;
    }
    
    .chart-legend {
        display: flex;
        gap: 16px;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: #8e8e93;
    }
    
    .legend-color {
        width: 12px;
        height: 12px;
        border-radius: 2px;
    }
    
    #trendsChart {
        max-height: 300px;
    }
    
    .metrics-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 12px;
    }
    
    .metric-item {
        text-align: center;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 8px;
    }
    
    .metric-item .metric-value {
        font-size: 16px;
        font-weight: 700;
        color: #1d1d1f;
        margin-bottom: 4px;
    }
    
    .metric-item .metric-label {
        font-size: 11px;
        color: #8e8e93;
        font-weight: 500;
    }
    
    @media (max-width: 1024px) {
        .trends-content {
            grid-template-columns: 1fr;
        }
    }
</style>

</body>
</html>