<%- include("../layout/navbar") -%>

<% if(err.length > 0) {%>
    <script>
        Swal.fire({
            icon: 'error',
            text: `<%= err%>`
        })
    </script>
<%} %>

<div class="transfer-container">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title">
            <ion-icon name="swap-horizontal-outline"></ion-icon>
            Transfer Items
        </h1>
        <p class="page-subtitle">
            <% if (direction === 'to-main') { %>
                Move items from Local Store to Main Storage
            <% } else if (direction === 'to-store') { %>
                Move items from Main Storage to Local Store
            <% } else { %>
                Move items between Main Storage and Local Store
            <% } %>
        </p>
    </div>

    <!-- Transfer Direction Card -->
    <div class="keep-card">
        <div class="keep-card-header">
            <div class="keep-card-title">
                <ion-icon name="git-compare-outline"></ion-icon>
                Transfer Direction
            </div>
        </div>
        <div class="keep-card-body">
            <div class="direction-cards">
                <!-- Transfer to Main Storage Button -->
                <div class="direction-card <% if (direction === 'to-main') { %>active<% } %>" onclick="window.location.href='/transfer/to-main'">
                    <div class="direction-content">
                        <div class="direction-icon">
                            <ion-icon name="arrow-up-outline"></ion-icon>
                        </div>
                        <div class="direction-info">
                            <h3>Transfer to Main Storage</h3>
                            <p>Move items from Local Store to Main Storage</p>
                        </div>
                    </div>
                </div>

                <!-- Transfer to Store Button -->
                <div class="direction-card <% if (direction === 'to-store' || !direction) { %>active<% } %>" onclick="window.location.href='/transfer'">
                    <div class="direction-content">
                        <div class="direction-icon">
                            <ion-icon name="arrow-down-outline"></ion-icon>
                        </div>
                        <div class="direction-info">
                            <h3>Transfer to Store</h3>
                            <p>Move items from Main Storage to Local Store</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Items Card -->
    <div class="keep-card">
        <div class="keep-card-header">
            <div class="keep-card-title">
                <ion-icon name="add-circle-outline"></ion-icon>
                Add Items to Transfer
            </div>
        </div>
        <div class="keep-card-body">
            <div class="action-bar">
                <!-- Barcode Scanner -->
                <div class="keep-input">
                    <input type="text" id="codeInput" name="code" placeholder="Scan or enter barcode" autocomplete="off" required>
                </div>
                <button type="button" onclick="addByBarcode()" class="keep-btn keep-btn-primary">
                    <ion-icon name="barcode-outline"></ion-icon>
                    Add by Barcode
                </button>
            </div>

            <!-- Search Autocomplete -->
            <div style="position: relative; margin-top: var(--space-md); z-index: 1000;" id="search-container">
                <div class="keep-input" style="width: 100%; max-width: 500px; overflow: visible;">
                    <input id="myInput" type="text" placeholder="Search for items by name and size" autocomplete="off" style="overflow: visible;">
                </div>
            </div>
        </div>
    </div>

    <!-- Transfer Items List -->
    <% if(products.length > 0) { %>
        <div class="transfer-list-card">
            <div class="transfer-list-header">
                <div>#</div>
                <div>Item</div>
                <div>Quantity</div>
                <div>Action</div>
            </div>
            <div class="transfer-list-body">
                <% products.forEach((product, index) => { %>
                    <div class="transfer-item" data-product-id="<%= product._id %>" data-stock="<%= product.stock %>" data-qty="<%= product.mainQty %>" data-current-qty="<%= product.transferQty %>">
                        <div class="item-index"><%= index + 1 %></div>
                        <div class="item-info" data-label="Item">
                            <div class="item-name"><%= product.name %></div>
                            <div class="item-details">
                                <span>Size: <%= product.size %></span>
                                <span>Color: <%= product.colorName %></span>
                            </div>
                        </div>
                        <div class="item-qty" data-label="Qty">
                            <%= product.qty %>
                        </div>
                        <div class="item-actions" data-label="Action">
                            <form action="/transfer/return/<%= product._id%>?_method=PUT&direction=<%= direction %>" method="post" style="display: inline;">
                                <button type="button" class="keep-btn keep-btn-icon keep-btn-danger"
                                        onclick="confirmRemove(this)"
                                        title="Remove item">
                                    <ion-icon name="trash-outline"></ion-icon>
                                </button>
                            </form>
                            <button class="keep-btn keep-btn-icon keep-btn-secondary"
                                    onclick="editQuantity('<%= product._id %>', '<%= direction %>')"
                                    title="Edit quantity">
                                <ion-icon name="create-outline"></ion-icon>
                            </button>
                        </div>
                    </div>
                <% }); %>
            </div>
        </div>

        <!-- Confirm Transfer Button -->
        <div class="confirm-transfer-card">
            <div class="confirm-header">
                <ion-icon name="checkmark-circle-outline"></ion-icon>
                Ready to Transfer
            </div>
            <div class="confirm-body">
                <div class="transfer-route">
                    <% if (direction === 'to-main') { %>
                        <span class="route-from">Local Store</span>
                        <ion-icon class="route-arrow" name="arrow-forward-outline"></ion-icon>
                        <span class="route-to">Main Storage</span>
                    <% } else if (direction === 'to-store') { %>
                        <span class="route-from">Main Storage</span>
                        <ion-icon class="route-arrow" name="arrow-forward-outline"></ion-icon>
                        <span class="route-to">Local Store</span>
                    <% } %>
                </div>
                <button type="button" onclick="confirmTransfer()" class="confirm-button">
                    <ion-icon name="paper-plane-outline"></ion-icon>
                    Confirm Transfer
                </button>
            </div>
        </div>
    <% } else { %>
        <!-- Empty State -->
        <div class="keep-card">
            <div class="empty-state">
                <div class="empty-icon">
                    <ion-icon name="cube-outline"></ion-icon>
                </div>
                <h3 class="empty-title">No Items in Transfer</h3>
                <p class="empty-description">
                    Add items to your transfer list by scanning a barcode or searching for products.
                    You can then move them between Main Storage and Local Store.
                </p>
            </div>
        </div>
    <% } %>
</div>


<script src="/javascript/autoselect.js"></script>
<script>
    function confirmRemove(button) {
        Swal.fire({
            title: 'Remove Item',
            text: 'Are you sure you want to remove this item from transfer?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#1a73e8',
            cancelButtonColor: '#757575',
            confirmButtonText: 'Remove',
            cancelButtonText: 'Cancel',
            customClass: {
                popup: 'keep-swal-popup',
                confirmButton: 'keep-swal-confirm',
                cancelButton: 'keep-swal-cancel'
            },
            showClass: {
                popup: 'animate__animated animate__fadeInDown'
            },
            hideClass: {
                popup: 'animate__animated animate__fadeOutUp'
            }
        }).then((result) => {
            if (result.isConfirmed) {
                const form = button.closest('form');
                form.submit();
            }
        });
    }

    function editQuantity(productId, direction) {
        // Get the product element to access available quantity
        const productElement = document.querySelector(`[data-product-id="${productId}"]`);
        let maxQty = 999999; // default high value
        let currentQty = 1;

        if (productElement) {
            // Extract available quantity from the product info
            // For to-main: use data-stock attribute
            // For to-store: use data-qty attribute
            if (direction === 'to-main') {
                maxQty = parseInt(productElement.dataset.stock) || 0;
            } else {
                maxQty = parseInt(productElement.dataset.qty) || 0;
            }
            // Get current transfer quantity
            currentQty = parseInt(productElement.dataset.currentQty) || 1;
        }

        Swal.fire({
            title: 'Edit Quantity',
            html: `
                <div style="text-align: left; margin-bottom: 16px;">
                    <p style="font-size: 13px; color: #616161; margin-bottom: 12px;">
                        Enter the new quantity (max: <strong>${maxQty}</strong> units available)
                    </p>
                </div>
            `,
            input: 'number',
            inputAttributes: {
                min: 1,
                max: maxQty,
                step: 1
            },
            inputValue: currentQty,
            showCancelButton: true,
            confirmButtonColor: '#1a73e8',
            cancelButtonColor: '#757575',
            confirmButtonText: 'Update',
            cancelButtonText: 'Cancel',
            customClass: {
                popup: 'keep-swal-popup',
                confirmButton: 'keep-swal-confirm',
                cancelButton: 'keep-swal-cancel'
            },
            showClass: {
                popup: 'animate__animated animate__fadeInDown'
            },
            hideClass: {
                popup: 'animate__animated animate__fadeOutUp'
            },
            inputValidator: (value) => {
                if (!value || value < 1) {
                    return 'Please enter a valid quantity';
                }
                if (parseInt(value) > maxQty) {
                    return `Quantity cannot exceed ${maxQty} units`;
                }
            }
        }).then((result) => {
            if (result.isConfirmed && result.value) {
                // Create a form and submit it
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/transfer/edit-qty/' + productId + '?_method=PUT';
                form.style.display = 'none';

                // Add quantity input
                const qtyInput = document.createElement('input');
                qtyInput.type = 'number';
                qtyInput.name = 'qty';
                qtyInput.value = result.value;
                form.appendChild(qtyInput);

                // Add direction input
                const directionInput = document.createElement('input');
                directionInput.type = 'hidden';
                directionInput.name = 'direction';
                directionInput.value = direction;
                form.appendChild(directionInput);

                document.body.appendChild(form);
                form.submit();
            }
        });
    }

    function confirmTransfer() {
        const currentDirection = "<%= direction || 'to-store' %>";

        // Create a form dynamically
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/transfer/confirm?_method=PUT';
        form.style.display = 'none';

        // Add min and add inputs based on direction
        const minInput = document.createElement('input');
        minInput.type = 'hidden';
        minInput.name = 'min';

        const addInput = document.createElement('input');
        addInput.type = 'hidden';
        addInput.name = 'add';

        if (currentDirection === 'to-main') {
            minInput.value = 'Local Store';
            addInput.value = 'Main Storage';
        } else {
            minInput.value = 'Main Storage';
            addInput.value = 'Local Store';
        }

        form.appendChild(minInput);
        form.appendChild(addInput);

        document.body.appendChild(form);
        form.submit();
    }

    function addByBarcode() {
        const codeInput = document.getElementById('codeInput');
        const codeValue = codeInput.value.trim();

        if (!codeValue) {
            Swal.fire({
                icon: 'error',
                title: 'Barcode Required',
                text: 'Please scan or enter a barcode.',
                showConfirmButton: true,
                customClass: {
                    popup: 'keep-swal-popup'
                }
            });
            codeInput.focus();
            return;
        }

        // Show loading state
        const button = document.querySelector('button[onclick="addByBarcode()"]');
        const originalText = button.innerHTML;
        button.innerHTML = '<ion-icon name="loader-outline" class="spinning"></ion-icon> Adding...';
        button.disabled = true;

        // Create a form and submit it as PUT
        const form = document.createElement('form');
        form.method = 'POST';
        const currentDirection = "<%= direction || 'to-store' %>";
        form.action = '/transfer/add-by-code/' + encodeURIComponent(codeValue) + '?_method=PUT&direction=' + currentDirection;
        form.style.display = 'none';

        document.body.appendChild(form);
        form.submit();
    }

    // Handle Enter key in barcode input
    document.getElementById('codeInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            addByBarcode();
        }
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
<script>
    // Autocomplete functionality
    function autocomplete(inp, arr) {
        let currentFocus;
        const fuse = new Fuse(arr, {
            threshold: 0.4,
        });

        inp.addEventListener("input", function () {
            let a, b, val = this.value;
            closeAllLists();
            if (!val) return false;
            currentFocus = -1;

            a = document.createElement("DIV");
            a.setAttribute("id", this.id + "autocomplete-list");
            a.setAttribute("class", "autocomplete-items");

            // Position the dropdown at body level to avoid clipping
            const inputRect = this.getBoundingClientRect();

            a.style.position = 'fixed';
            a.style.top = (inputRect.bottom + window.scrollY) + 'px';
            a.style.left = (inputRect.left + window.scrollX) + 'px';
            a.style.width = inputRect.width + 'px';
            a.style.zIndex = '99999';

            document.body.appendChild(a);

            const results = fuse.search(val);
            results.forEach(({ item }) => {
                b = document.createElement("DIV");
                b.innerHTML = `<strong>${item.substr(0, val.length)}</strong>${item.substr(val.length)}`;
                b.innerHTML += `<input type='hidden' value='${item}'>`;
                b.addEventListener("click", function () {
                    const searchTerm = String(this.getElementsByTagName("input")[0].value);
                    const currentDirection = "<%= direction || 'to-store' %>";
                    window.location.href = `/transfer/search/${encodeURIComponent(searchTerm)}?direction=${currentDirection}`;
                    closeAllLists();
                });
                a.appendChild(b);
            });
        });

        inp.addEventListener("keydown", function (e) {
            let x = document.getElementById(this.id + "autocomplete-list");
            if (x) x = x.getElementsByTagName("div");
            if (e.keyCode == 40) {
                currentFocus++;
                addActive(x);
            } else if (e.keyCode == 38) {
                currentFocus--;
                addActive(x);
            } else if (e.keyCode == 13) {
                e.preventDefault();
                if (currentFocus > -1 && x) x[currentFocus].click();
            }
        });

        function addActive(x) {
            if (!x) return false;
            removeActive(x);
            if (currentFocus >= x.length) currentFocus = 0;
            if (currentFocus < 0) currentFocus = x.length - 1;
            x[currentFocus].classList.add("autocomplete-active");
        }

        function removeActive(x) {
            for (let i = 0; i < x.length; i++) {
                x[i].classList.remove("autocomplete-active");
            }
        }

        function closeAllLists(elmnt) {
            const x = document.getElementsByClassName("autocomplete-items");
            for (let i = 0; i < x.length; i++) {
                if (elmnt != x[i] && elmnt != inp) {
                    x[i].remove();
                }
            }
        }

        document.addEventListener("click", function (e) {
            closeAllLists(e.target);
        });
    }

    const data = "<%= data %>".split(",");
    autocomplete(document.getElementById("myInput"), data);
</script>

<style>
    .keep-swal-popup {
        border-radius: 12px !important;
        box-shadow: 0 6px 10px 0 rgba(60,64,67,.3), 0 4px 12px 4px rgba(60,64,67,.15) !important;
        overflow: hidden;
    }

    .keep-swal-confirm {
        background: #1a73e8 !important;
        border-radius: 6px !important;
        font-family: 'Inter', sans-serif !important;
        font-weight: 500 !important;
        padding: 8px 24px !important;
    }

    .keep-swal-confirm:hover {
        background: #1557b0 !important;
    }

    .keep-swal-cancel {
        background: #f5f5f5 !important;
        color: #212121 !important;
        border-radius: 6px !important;
        font-family: 'Inter', sans-serif !important;
        font-weight: 500 !important;
        padding: 8px 24px !important;
    }

    .keep-swal-cancel:hover {
        background: #eeeeee !important;
    }

    .animate__animated {
        animation-duration: 0.3s !important;
    }

    .spinning {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
</style>

<%- include("../layout/footer") -%>
