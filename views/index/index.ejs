<%- include("../layout/navbar") -%>

<% if(err && err.length > 0) {%>
    <script>
        Swal.fire({
            icon: "error",
            title: "Permission Required",
            text: "You don't have permission to enter this section"
        })
    </script>
<%}%>

<!-- Modern Dashboard Container -->
<div class="dashboard-container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <h1 class="dashboard-title">Dashboard</h1>
        <p class="dashboard-subtitle">Welcome back, <%= user ? user.name : 'Admin' %>! Here's what's happening with your store today.</p>
    </div>

    <!-- Quick Stats Grid -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-header">
                <h3 class="stat-title">Total Products</h3>
                <div class="stat-icon primary">
                    <ion-icon name="cube-outline"></ion-icon>
                </div>
            </div>
            <div class="stat-value"><%= products ? products.length : 0 %></div>
            <div class="stat-change positive">
                <ion-icon name="trending-up-outline"></ion-icon>
                <span>+12% from last month</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-header">
                <h3 class="stat-title">Low Stock Items</h3>
                <div class="stat-icon warning">
                    <ion-icon name="warning-outline"></ion-icon>
                </div>
            </div>
            <div class="stat-value"><%= products ? products.filter(p => p.qty < 10).length : 0 %></div>
            <div class="stat-change negative">
                <ion-icon name="trending-down-outline"></ion-icon>
                <span>Need attention</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-header">
                <h3 class="stat-title">Recent Orders</h3>
                <div class="stat-icon success">
                    <ion-icon name="bag-handle-outline"></ion-icon>
                </div>
            </div>
            <div class="stat-value"><%= sell ? sell.length : 0 %></div>
            <div class="stat-change positive">
                <ion-icon name="trending-up-outline"></ion-icon>
                <span>Active orders</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-header">
                <h3 class="stat-title">System Status</h3>
                <div class="stat-icon success">
                    <ion-icon name="shield-checkmark-outline"></ion-icon>
                </div>
            </div>
            <div class="stat-value">Online</div>
            <div class="stat-change positive">
                <ion-icon name="checkmark-circle-outline"></ion-icon>
                <span>All systems operational</span>
            </div>
        </div>

        <!-- New Analysis Card 1: Total Revenue -->
        <div class="stat-card">
            <div class="stat-header">
                <h3 class="stat-title">Total Revenue</h3>
                <div class="stat-icon success">
                    <ion-icon name="cash-outline"></ion-icon>
                </div>
            </div>
            <div class="stat-value">IQD <%= (totalRevenue || 0).toLocaleString() %></div>
            <div class="stat-change positive">
                <ion-icon name="trending-up-outline"></ion-icon>
                <span>From completed sales</span>
            </div>
        </div>

        <!-- New Analysis Card 2: Customer Satisfaction -->
        <div class="stat-card">
            <div class="stat-header">
                <h3 class="stat-title">Customer Satisfaction</h3>
                <div class="stat-icon primary">
                    <ion-icon name="star-outline"></ion-icon>
                </div>
            </div>
            <div class="stat-value"><%= customerSatisfaction || 0 %>%</div>
            <div class="stat-change positive">
                <ion-icon name="heart-outline"></ion-icon>
                <span>Average rating</span>
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="content-grid">
        <!-- Featured Product Card - Apple UI/UX Design -->
        <div class="content-card premium-featured-card">
            <div class="card-header premium-card-header">
                <div class="header-content">
                    <h2 class="card-title premium-title">
                        Featured Product
                    </h2>
                </div>
                <button class="card-action premium-action" onclick="window.location.href='/items'">
                    <ion-icon name="grid-outline"></ion-icon>
                    View All
                </button>
            </div>
            <div class="card-content premium-content">
                <% if(product){ %>
                    <div class="premium-product-showcase">
                        <!-- Product Image Section -->
                        <div class="product-image-container">
                            <div class="image-frame">
                                <img src="/upload/images/<%= product.image%>" alt="<%= product.name%>" class="premium-product-image">
                                <div class="image-overlay">
                                    <div class="stock-indicator <%= product.qty < 10 ? 'low' : product.qty < 30 ? 'medium' : 'high' %>">
                                        <ion-icon name="<%= product.qty < 10 ? 'warning' : 'checkmark-circle' %>"></ion-icon>
                                        <span><%= product.qty %> in stock</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Product Info Section -->
                        <div class="product-info-container">
                            <div class="product-header">
                                <h3 class="product-name premium-product-name"><%= product.name%></h3>
                                <div class="product-category">
                                    <ion-icon name="pricetags-outline"></ion-icon>
                                    <span><%= product.category || 'General' %></span>
                                </div>
                            </div>

                            <!-- Product Specifications -->
                            <div class="product-specs">
                                <div class="spec-group">
                                    <div class="spec-item">
                                        <span class="spec-label">Size</span>
                                        <span class="spec-value"><%= product.size || 'N/A' %></span>
                                    </div>
                                    <div class="spec-item">
                                        <span class="spec-label">Color</span>
                                        <div class="color-preview">
                                            <div class="color-circle" style="background-color: <%= product.color%>"></div>
                                            <span class="color-name"><%= product.colorName || 'Custom' %></span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Pricing Section -->
                            <div class="pricing-section">
                                <div class="price-container">
                                    <span class="currency">IQD</span>
                                    <span class="price"><%= (product.sell_price || 0).toLocaleString() %></span>
                                </div>
                                <div class="price-details">
                                    <span class="cost-price">Cost: IQD <%= (product.price || 0).toLocaleString() %></span>
                                    <% if(product.price && product.sell_price) { 
                                        const profit = product.sell_price - product.price;
                                        const profitMargin = product.price > 0 ? Math.round((profit / product.price) * 100) : 0;
                                    %>
                                        <span class="profit-badge">
                                            <ion-icon name="trending-up-outline"></ion-icon>
                                            Profit: <%= profit.toLocaleString() %> (<%= profitMargin %>%)
                                        </span>
                                    <% } %>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="action-buttons">
                                <button class="btn-primary" onclick="window.location.href='/items/edit/<%= product.id%>'">
                                    <ion-icon name="create-outline"></ion-icon>
                                    Edit Product
                                </button>
                                <button class="btn-primary" onclick="window.location.href='/items/get/<%= product.id%>'">
                                    <ion-icon name="eye-outline"></ion-icon>
                                    View Details
                                </button>
                            </div>
                        </div>
                    </div>
                <% } else { %>
                    <div class="empty-state premium-empty-state">
                        <div class="empty-illustration-premium">
                            <div class="empty-icon-container">
                                <ion-icon name="cube-outline" class="empty-icon-premium"></ion-icon>
                            </div>
                            <div class="empty-decoration">
                                <div class="decoration-circle"></div>
                                <div class="decoration-circle"></div>
                            </div>
                        </div>
                        <h3 class="empty-title">No Products Available</h3>
                        <p class="empty-description">Start by adding your first product to see premium analytics and insights here.</p>
                        <button class="empty-action premium-empty-action" onclick="window.location.href='/items/add-item'">
                            <ion-icon name="add-circle-outline"></ion-icon>
                            Add First Product
                        </button>
                    </div>
                <% } %>
            </div>
        </div>

        <!-- Apple-Style Recent Activity -->
        <div class="apple-activity-card">
            <div class="activity-header">
                <div class="activity-header-content">
                    <h2 class="activity-title">Recent Activity</h2>
                    <span class="activity-subtitle">Live updates from your store</span>
                </div>
                <button class="activity-action-btn" onclick="window.location.href='/analysis'">
                    <ion-icon name="analytics-outline"></ion-icon>
                    <span>View Analytics</span>
                </button>
            </div>
            <div class="activity-timeline">
                <div class="timeline-item success">
                    <div class="timeline-indicator">
                        <div class="indicator-dot success"></div>
                    </div>
                    <div class="timeline-content">
                        <div class="timeline-text">
                            <span class="activity-label">New order received</span>
                            <span class="activity-badge success">Order</span>
                        </div>
                        <span class="activity-timestamp">2 min ago</span>
                    </div>
                </div>
                <div class="timeline-item warning">
                    <div class="timeline-indicator">
                        <div class="indicator-dot warning"></div>
                    </div>
                    <div class="timeline-content">
                        <div class="timeline-text">
                            <span class="activity-label">Low stock alert</span>
                            <span class="activity-badge warning">Alert</span>
                        </div>
                        <span class="activity-timestamp">1 hour ago</span>
                    </div>
                </div>
                <div class="timeline-item primary">
                    <div class="timeline-indicator">
                        <div class="indicator-dot primary"></div>
                    </div>
                    <div class="timeline-content">
                        <div class="timeline-text">
                            <span class="activity-label">Product updated</span>
                            <span class="activity-badge primary">Update</span>
                        </div>
                        <span class="activity-timestamp">3 hours ago</span>
                    </div>
                </div>
                <div class="timeline-item neutral">
                    <div class="timeline-indicator">
                        <div class="indicator-dot neutral"></div>
                    </div>
                    <div class="timeline-content">
                        <div class="timeline-text">
                            <span class="activity-label">Inventory synced</span>
                            <span class="activity-badge neutral">Sync</span>
                        </div>
                        <span class="activity-timestamp">5 hours ago</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Apple-Style Low Stock Alert -->
    <div class="apple-low-stock-card">
        <div class="stock-header">
            <div class="stock-header-content">
                <h2 class="stock-title">Low Stock Alert</h2>
                <span class="stock-subtitle">Items requiring attention</span>
            </div>
            <button class="stock-action-btn" onclick="window.location.href='/storage'">
                <ion-icon name="grid-outline"></ion-icon>
                <span>Manage Inventory</span>
            </button>
        </div>
        
        <% if(products && products.filter(p => p.qty < 10).length > 0) { %>
            <div class="stock-alert-grid">
                <% products.filter(p => p.qty < 10).slice(0, 4).forEach((item, index) => { 
                    const stockLevel = item.qty < 5 ? 'critical' : item.qty < 8 ? 'warning' : 'low';
                    const stockPercentage = Math.min((item.qty / 20) * 100, 100);
                %>
                    <div class="stock-item-card" onclick="window.location.href='/items/get/<%= item.id%>'" style="animation-delay: <%= index * 0.1 %>s">
                        <div class="stock-item-image">
                            <img src="/upload/images/<%= item.image%>" alt="<%= item.name%>" class="stock-image">
                            <div class="stock-status-badge <%= stockLevel %>">
                                <ion-icon name="<%= stockLevel === 'critical' ? 'warning' : 'alert-circle' %>"></ion-icon>
                            </div>
                        </div>
                        <div class="stock-item-content">
                            <h4 class="stock-item-name"><%= item.name%></h4>
                            <div class="stock-level-indicator">
                                <span class="stock-quantity"><%= item.qty %> units</span>
                                <div class="stock-progress">
                                    <div class="stock-progress-bar">
                                        <div class="stock-progress-fill <%= stockLevel %>" style="width: <%= stockPercentage %>%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                <% }) %>
            </div>
            
            <div class="stock-footer">
                <div class="stock-summary">
                    <span class="summary-text">
                        <strong><%= products.filter(p => p.qty < 10).length %></strong> items need restocking
                    </span>
                </div>
                <button class="stock-view-all-btn" onclick="window.location.href='/storage'">
                    View All Items
                    <ion-icon name="chevron-forward-outline"></ion-icon>
                </button>
            </div>
        <% } else { %>
            <div class="stock-empty-state">
                <div class="empty-illustration">
                    <div class="empty-icon-container">
                        <ion-icon name="shield-checkmark-outline" class="empty-icon"></ion-icon>
                    </div>
                </div>
                <h3 class="empty-title">All Stock Levels Good</h3>
                <p class="empty-description">No products are currently low on stock.</p>
            </div>
        <% } %>
    </div>
    <!-- Apple-Style Recent Orders -->
    <div class="apple-orders-card">
        <div class="orders-header">
            <div class="orders-header-content">
                <h2 class="orders-title">Recent Orders</h2>
                <span class="orders-subtitle">Latest customer purchases</span>
            </div>
            <button class="orders-action-btn" onclick="window.location.href='/sell'">
                <ion-icon name="receipt-outline"></ion-icon>
                <span>View All Orders</span>
            </button>
        </div>
        
        <% if(sell && sell.length > 0) { %>
            <div class="orders-list-container">
                <% sell.slice(0, 5).forEach((order, index) => { 
                    const statusConfig = {
                        'pending': { 
                            bg: 'linear-gradient(135deg, #FF9500, #FF8C00)', 
                            text: '#FFFFFF', 
                            icon: 'time-outline',
                            label: 'Pending'
                        },
                        'done': { 
                            bg: 'linear-gradient(135deg, #30D158, #20B954)', 
                            text: '#FFFFFF', 
                            icon: 'checkmark-circle-outline',
                            label: 'Completed'
                        },
                        'processing': { 
                            bg: 'linear-gradient(135deg, #007AFF, #0056CC)', 
                            text: '#FFFFFF', 
                            icon: 'sync-outline',
                            label: 'Processing'
                        },
                        'cancelled': { 
                            bg: 'linear-gradient(135deg, #FF3B30, #E74C3C)', 
                            text: '#FFFFFF', 
                            icon: 'close-circle-outline',
                            label: 'Cancelled'
                        }
                    };
                    const status = statusConfig[order.status] || statusConfig['pending'];
                    const orderNumber = order.id.substring(0, 8).toUpperCase();
                    const orderDate = new Date(order.Date).toLocaleDateString('en-US', { 
                        month: 'short', 
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    const totalAmount = order.products?.reduce((sum, p) => sum + (p.total || 0), 0) || 0;
                    const itemCount = order.products?.length || 0;
                %>
                    <div class="order-row" onclick="window.location.href='/sell/get-data/<%= order.id%>'" style="animation-delay: <%= index * 0.08 %>s">
                        <div class="order-status">
                            <div class="status-indicator" style="background: <%= status.bg %>;">
                                <ion-icon name="<%= status.icon %>"></ion-icon>
                            </div>
                            <span class="status-label <%= order.status %>"><%= status.label %></span>
                        </div>
                        
                        <div class="order-main-content">
                            <div class="order-header-row">
                                <div class="order-info-left">
                                    <span class="order-number">#<%= orderNumber %></span>
                                    <span class="order-item-count"><%= itemCount %> item<%= itemCount !== 1 ? 's' : '' %></span>
                                </div>
                                <div class="order-info-right">
                                    <span class="order-amount">IQD <%= totalAmount.toLocaleString() %></span>
                                </div>
                            </div>
                            
                            <div class="order-details-row">
                                <div class="order-meta">
                                    <div class="meta-item">
                                        <ion-icon name="person-outline"></ion-icon>
                                        <span><%= order.phone %></span>
                                    </div>
                                    <div class="meta-item">
                                        <ion-icon name="calendar-outline"></ion-icon>
                                        <span><%= orderDate %></span>
                                    </div>
                                    <% if(order.adress) { %>
                                        <div class="meta-item">
                                            <ion-icon name="location-outline"></ion-icon>
                                            <span><%= order.adress.length > 25 ? order.adress.substring(0, 25) + '...' : order.adress %></span>
                                        </div>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                        
                        <div class="order-action">
                            <ion-icon name="chevron-forward-outline"></ion-icon>
                        </div>
                    </div>
                <% }) %>
            </div>
            
            <div class="orders-footer">
                <button class="view-all-orders-btn" onclick="window.location.href='/sell'">
                    View All Orders
                    <ion-icon name="arrow-forward-outline"></ion-icon>
                </button>
            </div>
        <% } else { %>
            <div class="orders-empty-state">
                <div class="empty-illustration">
                    <div class="empty-icon-container">
                        <ion-icon name="receipt-outline" class="empty-icon"></ion-icon>
                    </div>
                </div>
                <h3 class="empty-title">No Recent Orders</h3>
                <p class="empty-description">Orders will appear here when customers make purchases.</p>
                <button class="empty-action-btn" onclick="window.location.href='/sell'">
                    <ion-icon name="add-circle-outline"></ion-icon>
                    Create First Order
                </button>
            </div>
        <% } %>
    </div>
</div>


<%- include("../layout/footer") -%>