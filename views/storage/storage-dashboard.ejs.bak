<%- include('../layout/navbar') -%>

<% if(err && err.length > 0) {%>
    <script>
        Swal.fire({
            icon: "error",
            title: "Permission Required", 
            text: "You don't have permission to enter this section"
        })
    </script>
<%}%>

<!-- Modern Dashboard Container -->
<div class="dashboard-container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <h1 class="dashboard-title">Storage</h1>
        <p class="dashboard-subtitle">Inventory Management - Comprehensive control and analytics</p>
    </div>

    <!-- Quick Stats Grid -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-header">
                <h3 class="stat-title">Total Products</h3>
                <div class="stat-icon primary">
                    <ion-icon name="cube-outline"></ion-icon>
                </div>
            </div>
            <div class="stat-value"><%= analytics.totalProducts || 0 %></div>
            <div class="stat-change positive">
                <ion-icon name="add-circle-outline"></ion-icon>
                <span>Manage Inventory</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-header">
                <h3 class="stat-title">Total Value</h3>
                <div class="stat-icon success">
                    <ion-icon name="cash-outline"></ion-icon>
                </div>
            </div>
            <div class="stat-value">IQD <%= (analytics.totalPotentialRevenue || 0).toLocaleString() %></div>
            <div class="stat-change positive">
                <ion-icon name="trending-up-outline"></ion-icon>
                <span>Inventory worth</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-header">
                <h3 class="stat-title">Low Stock</h3>
                <div class="stat-icon warning">
                    <ion-icon name="alert-circle"></ion-icon>
                </div>
            </div>
            <div class="stat-value"><%= analytics.lowStockItems || 0 %></div>
            <div class="stat-change negative">
                <ion-icon name="warning-outline"></ion-icon>
                <span>Need attention</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-header">
                <h3 class="stat-title">Average Price</h3>
                <div class="stat-icon primary">
                    <ion-icon name="pricetag"></ion-icon>
                </div>
            </div>
            <div class="stat-value">IQD <%= (analytics.avgSellPrice || 0).toLocaleString() %></div>
            <div class="stat-change positive">
                <ion-icon name="analytics-outline"></ion-icon>
                <span>Per item average</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-header">
                <h3 class="stat-title">Out of Stock</h3>
                <div class="stat-icon danger">
                    <ion-icon name="close-circle-outline"></ion-icon>
                </div>
            </div>
            <div class="stat-value"><%= analytics.outOfStockItems || 0 %></div>
            <div class="stat-change negative">
                <ion-icon name="warning-outline"></ion-icon>
                <span>Need restocking</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-header">
                <h3 class="stat-title">Potential Profit</h3>
                <div class="stat-icon success">
                    <ion-icon name="trending-up-outline"></ion-icon>
                </div>
            </div>
            <div class="stat-value">IQD <%= (analytics.totalPotentialProfit || 0).toLocaleString() %></div>
            <div class="stat-change positive">
                <ion-icon name="cash-outline"></ion-icon>
                <span>If all sold</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-header">
                <h3 class="stat-title">Total Categories</h3>
                <div class="stat-icon primary">
                    <ion-icon name="library-outline"></ion-icon>
                </div>
            </div>
            <div class="stat-value"><%= analytics.totalCategories || 0 %></div>
            <div class="stat-change positive">
                <ion-icon name="layers-outline"></ion-icon>
                <span>Product diversity</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-header">
                <h3 class="stat-title">Reorder Alerts</h3>
                <div class="stat-icon warning">
                    <ion-icon name="notifications-outline"></ion-icon>
                </div>
            </div>
            <div class="stat-value"><%= analytics.reorderAlertItems || 0 %></div>
            <div class="stat-change negative">
                <ion-icon name="alert-outline"></ion-icon>
                <span>Below threshold</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-header">
                <h3 class="stat-title">High Value Items</h3>
                <div class="stat-icon success">
                    <ion-icon name="diamond-outline"></ion-icon>
                </div>
            </div>
            <div class="stat-value"><%= analytics.highValueItems || 0 %></div>
            <div class="stat-change positive">
                <ion-icon name="star-outline"></ion-icon>
                <span>Premium products</span>
            </div>
        </div>
    </div>

    <!-- Premium Inventory Controls -->
    <div class="premium-inventory-controls">
        <div class="controls-header">
            <div class="header-content">
                <div class="header-icon">
                    <ion-icon name="cube-outline"></ion-icon>
                </div>
                <div class="header-text">
                    <h2 class="controls-title">Inventory Controls</h2>
                    <p class="controls-subtitle">Advanced inventory management and analytics</p>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn-export" onclick="exportInventory()">
                    <ion-icon name="download-outline"></ion-icon>
                    Export
                </button>
                <button class="btn-export" onclick="window.location.href='/items/add'">
                    <ion-icon name="add-outline"></ion-icon>
                    Add Item
                </button>
            </div>
        </div>

        <div class="controls-content">
            <!-- Search and Quick Actions Row -->
            <div class="search-row">
                <div class="search-container">
                    <div class="search-box-modern">
                        <ion-icon name="search-outline" class="search-icon"></ion-icon>
                        <input type="text" id="globalSearch" class="search-input" placeholder="Search products, SKU, categories, or brands..." oninput="handleSearch(this.value)" />
                        <button class="search-clear" onclick="clearSearch()" style="display: none;">
                            <ion-icon name="close-circle-outline"></ion-icon>
                        </button>
                    </div>
                </div>
                
                <div class="quick-actions">
                    <button class="quick-action-btn" onclick="filterLowStock()">
                        <ion-icon name="warning-outline"></ion-icon>
                        <span>Low Stock</span>
                    </button>
                    <button class="quick-action-btn" onclick="filterOutOfStock()">
                        <ion-icon name="close-circle-outline"></ion-icon>
                        <span>Out of Stock</span>
                    </button>
                </div>
            </div>

            <!-- Filters Row -->
            <div class="filters-row">
                <div class="filter-groups">
                    <div class="filter-group-modern">
                        <label class="filter-label">
                            <ion-icon name="swap-vertical-outline"></ion-icon>
                            Sort by
                        </label>
                        <select id="sortFilter" class="filter-select" onchange="applyFilters()">
                            <option value="">Default (Newest)</option>
                            <option value="qty-most">Quantity (High to Low)</option>
                            <option value="qty-less">Quantity (Low to High)</option>
                            <option value="price-most">Price (High to Low)</option>
                            <option value="price-less">Price (Low to High)</option>
                            <option value="name-asc">Name (A-Z)</option>
                            <option value="name-desc">Name (Z-A)</option>
                            <option value="profit-desc">Profit Margin (High to Low)</option>
                            <option value="profit-asc">Profit Margin (Low to High)</option>
                            <option value="updated-desc">Recently Updated</option>
                        </select>
                    </div>

                    <div class="filter-group-modern">
                        <label class="filter-label">
                            <ion-icon name="resize-outline"></ion-icon>
                            Size
                        </label>
                        <select id="sizeFilter" class="filter-select" onchange="applyFilters()">
                            <option value="">All Sizes</option>
                            <% if (typeof size !== 'undefined' && size && size.length > 0) { %>
                                <% size.forEach(sizeData => { %>
                                    <option value="<%= sizeData.size %>"><%= sizeData.size %></option>
                                <% }); %>
                            <% } %>
                        </select>
                    </div>

                    <div class="filter-group-modern">
                        <label class="filter-label">
                            <ion-icon name="library-outline"></ion-icon>
                            Category
                        </label>
                        <select id="categoryFilter" class="filter-select" onchange="applyFilters()">
                            <option value="">All Categories</option>
                            <% 
                                // Get unique categories from ALL products (not just paginated ones)
                                const uniqueCategories = [];
                                if (allProductsForCategories && allProductsForCategories.length > 0) {
                                    allProductsForCategories.forEach(product => {
                                        const category = product.category || product.name; // Fallback to name if category is empty
                                        if (category && !uniqueCategories.includes(category)) {
                                            uniqueCategories.push(category);
                                        }
                                    });
                                }
                                uniqueCategories.sort().forEach(category => { 
                            %>
                                <option value="<%= category %>"><%= category %></option>
                            <% }); %>
                        </select>
                    </div>

                    <div class="filter-group-modern">
                        <label class="filter-label">
                            <ion-icon name="pricetags-outline"></ion-icon>
                            Stock Status
                        </label>
                        <select id="stockFilter" class="filter-select" onchange="applyFilters()">
                            <option value="">All Items</option>
                            <option value="in-stock">In Stock (10+)</option>
                            <option value="low-stock">Low Stock (1-10)</option>
                            <option value="out-of-stock">Out of Stock</option>
                            <option value="overstocked">Overstocked (100+)</option>
                        </select>
                    </div>

                    <div class="filter-group-modern">
                        <label class="filter-label">
                            <ion-icon name="cash-outline"></ion-icon>
                            Price Range
                        </label>
                        <select id="priceFilter" class="filter-select" onchange="applyFilters()">
                            <option value="">All Prices</option>
                            <option value="0-50000">Under 50K IQD</option>
                            <option value="50000-100000">50K - 100K IQD</option>
                            <option value="100000-500000">100K - 500K IQD</option>
                            <option value="500000+">Over 500K IQD</option>
                        </select>
                    </div>
                </div>

                <div class="filter-actions">
                    <button class="btn-reset" onclick="resetAllFilters()">
                        <ion-icon name="refresh-outline"></ion-icon>
                        Reset
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Premium Inventory Items Section -->
    <div class="premium-inventory-items">
        <div class="items-header">
            <div class="header-stats">
                <div class="stat-item">
                    <span class="stat-label">Total Items</span>
                    <span class="stat-value"><%= analytics.totalProducts || 0 %></span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">In Stock</span>
                    <span class="stat-value success">
                        <%= analytics.inStockItems || 0 %>
                    </span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Low Stock</span>
                    <span class="stat-value warning">
                        <%= analytics.lowStockItems || 0 %>
                    </span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Out of Stock</span>
                    <span class="stat-value danger">
                        <%= analytics.outOfStockItems || 0 %>
                    </span>
                </div>
            </div>
            
            <div class="header-controls">
                <div class="view-toggle">
                    <button class="view-btn active" data-view="grid" onclick="switchView('grid')" title="Grid View">
                        <ion-icon name="grid-outline"></ion-icon>
                    </button>
                    <button class="view-btn" data-view="list" onclick="switchView('list')" title="List View">
                        <ion-icon name="list-outline"></ion-icon>
                    </button>
                    <button class="view-btn" data-view="compact" onclick="switchView('compact')" title="Compact View">
                        <ion-icon name="apps-outline"></ion-icon>
                    </button>
                </div>
                
                <div class="items-per-page">
                    <span class="scroll-notice">Scroll to load more items</span>
                </div>
            </div>
        </div>

        <% if (products && products.length > 0) { %>
            <div class="products-container" id="productsGrid">
                <% products.forEach((product, index) => {
                    const totalStock = (product.qty || 0) + (product.stock || 0);
                    const profit = ((product.sell_price || 0) - (product.price || 0)) * totalStock;
                    const profitMargin = product.price > 0 ? ((product.sell_price - product.price) / product.price * 100) : 0;
                    const stockStatus = totalStock === 0 ? 'out-of-stock' : totalStock <= 10 ? 'low-stock' : 'in-stock';
                %>
                    <div class="product-card-modern" data-product-id="<%= product._id %>">
                        <!-- Product Selection Checkbox -->
                        <div class="product-checkbox">
                            <input type="checkbox" id="select-<%= product._id %>" onchange="toggleProductSelection('<%= product._id %>')">
                            <label for="select-<%= product._id %>"></label>
                        </div>
                        
                        <!-- Product Image Section -->
                        <div class="product-image-section">
                            <div class="image-container">
                                <% if (product.image && product.image !== 'none' && product.image.trim() !== '') { %>
                                    <% 
                                        let imagePath = product.image;
                                        // Check if image path already starts with /upload/images/
                                        if (!imagePath.startsWith('/upload/images/')) {
                                            imagePath = '/upload/images/' + imagePath;
                                        }
                                    %>
                                    <img src="<%= imagePath %>" alt="<%= product.name %>" class="product-image" 
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                                    <div class="no-image-placeholder" style="display: none;">
                                        <ion-icon name="image-outline"></ion-icon>
                                    </div>
                                <% } else { %>
                                    <div class="no-image-placeholder">
                                        <ion-icon name="image-outline"></ion-icon>
                                    </div>
                                <% } %>
                                
                                <!-- Status Badge -->
                                <div class="status-badge <%= stockStatus %>">
                                    <% if (stockStatus === 'out-of-stock') { %>
                                        <ion-icon name="close-circle-outline"></ion-icon>
                                        <span>Out of Stock</span>
                                    <% } else if (stockStatus === 'low-stock') { %>
                                        <ion-icon name="warning-outline"></ion-icon>
                                        <span>Low Stock</span>
                                    <% } else { %>
                                        <ion-icon name="checkmark-circle-outline"></ion-icon>
                                        <span>In Stock</span>
                                    <% } %>
                                </div>
                                
                                <!-- Quick Actions Overlay -->
                                <div class="quick-actions-overlay">
                                    <button class="quick-action" onclick="event.stopPropagation(); viewProduct('<%= product._id %>')" title="View Details">
                                        <ion-icon name="eye-outline"></ion-icon>
                                    </button>
                                    <button class="quick-action" onclick="event.stopPropagation(); editProduct('<%= product._id %>')" title="Edit Product">
                                        <ion-icon name="create-outline"></ion-icon>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Product Information -->
                        <div class="product-info-section">
                            <div class="product-header">
                                <h3 class="product-name" title="<%= product.name %>"><%= product.name %></h3>
                                <div class="product-sku">SKU: <%= product.sku || 'N/A' %></div>
                            </div>
                            
                            <!-- Product Variants -->
                            <div class="product-variants">
                                <% if (product.colorName || product.color) { %>
                                    <div class="variant-item">
                                        <span class="variant-label">Color:</span>
                                        <div class="color-info">
                                            <% if (product.colorHex) { %>
                                                <div class="color-dot" style="background-color: <%= product.colorHex %>"></div>
                                            <% } %>
                                            <span class="variant-value"><%= product.colorName || product.color %></span>
                                        </div>
                                    </div>
                                <% } %>
                                <% if (product.size) { %>
                                    <div class="variant-item">
                                        <span class="variant-label">Size:</span>
                                        <span class="variant-value size-badge"><%= product.size %></span>
                                    </div>
                                <% } %>
                                <% if (product.category || product.name) { %>
                                    <div class="variant-item">
                                        <span class="variant-label">Category:</span>
                                        <span class="variant-value category-badge"><%= product.category || product.name %></span>
                                    </div>
                                <% } %>
                            </div>
                            
                            <!-- Stock Information -->
                            <div class="stock-section">
                                
                                
                                <div class="stock-breakdown">
                                    <div class="stock-location">
                                        <span class="location-label">Main Storage</span>
                                        <span class="location-value"><%= product.qty || 0 %></span>
                                    </div>
                                    <div class="stock-location">
                                        <span class="location-label">Store</span>
                                        <span class="location-value"><%= product.stock || 0 %></span>
                                    </div>
                                </div>
                                
                                <!-- Stock Progress Bar -->
                                <div class="stock-progress">
                                    <div class="progress-bar">
                                        <div class="progress-fill <%= stockStatus %>" style="width: <%= Math.min((totalStock / 50) * 100, 100) %>%"></div>
                                    </div>
                                    <span class="progress-text"><%= totalStock %> / 50 units</span>
                                </div>
                            </div>
                            
                            <!-- Pricing Information -->
                            <div class="pricing-section">
                                <div class="price-grid">
                                    <div class="price-item">
                                        <span class="price-label">Cost Price</span>
                                        <span class="price-value cost">IQD <%= (product.price || 0).toLocaleString() %></span>
                                    </div>
                                    <div class="price-item">
                                        <span class="price-label">Selling Price</span>
                                        <span class="price-value selling">IQD <%= (product.sell_price || 0).toLocaleString() %></span>
                                    </div>
                                </div>
                                
                                <% if (profit > 0) { %>
                                    <div class="profit-section">
                                        <div class="profit-info">
                                            <span class="profit-label">Potential Profit</span>
                                            <span class="profit-value">IQD <%= profit.toLocaleString() %></span>
                                        </div>
                                        <div class="profit-margin">
                                            <span class="margin-label">Margin:</span>
                                            <span class="margin-value <%= profitMargin >= 50 ? 'high' : profitMargin >= 20 ? 'medium' : 'low' %>">
                                                <%= profitMargin.toFixed(1) %>%
                                            </span>
                                        </div>
                                    </div>
                                <% } %>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="product-actions">
                            <button class="action-btn primary" onclick="event.stopPropagation(); editProduct('<%= product._id %>')">
                                <ion-icon name="create-outline"></ion-icon>
                                <span>Edit</span>
                            </button>
                            <button class="action-btn secondary" onclick="event.stopPropagation(); manageStock('<%= product._id %>')">
                                <ion-icon name="barcode-outline"></ion-icon>
                                <span>Stock</span>
                            </button>
                            <button class="action-btn tertiary" onclick="event.stopPropagation(); quickSell('<%= product._id %>')">
                                <ion-icon name="cash-outline"></ion-icon>
                                <span>Sell</span>
                            </button>
                            <button class="action-btn danger" onclick="event.stopPropagation(); deleteProduct('<%= product._id %>')">
                                <ion-icon name="trash-outline"></ion-icon>
                            </button>
                        </div>
                    </div>
                <% }); %>
            </div>
            
            <!-- Pagination -->
            <% const limit = initialLimit; %>
            <div class="pagination-container">
                <div class="pagination-info">
                    <% if (products && products.length > 0) { %>
                        <% 
                            // Get current page from URL or default to 1
                            const urlParams = (typeof window !== 'undefined') ? new URLSearchParams(window.location.search) : new URLSearchParams();
                            const page = parseInt(urlParams.get('page')) || 1;
                            const limitParam = urlParams.get('limit');
                            const isShowingAll = limitParam === 'all' || limitParam === '0' || !limitParam;
                            const showingFrom = isShowingAll ? 1 : (page - 1) * limit + 1;
                            const showingTo = isShowingAll ? products.length : Math.min(page * limit, products.length);
                        %>
                        Showing <span id="showingFrom"><%= showingFrom %></span> to <span id="showingTo"><%= showingTo %></span> of <span id="totalItems"><%= products.length %></span> items
                    <% } else { %>
                        No items to display
                    <% } %>
                </div>
                <% if (limit !== 0) { %>
                <div class="pagination-controls">
                    <button class="pagination-btn" onclick="previousPage()" disabled>
                        <ion-icon name="chevron-back-outline"></ion-icon>
                    </button>
                    <div class="page-numbers" id="pageNumbers"></div>
                    <button class="pagination-btn" onclick="nextPage()">
                        <ion-icon name="chevron-forward-outline"></ion-icon>
                    </button>
                </div>
                <% } %>
            </div>
            
        <% } else { %>
            <!-- Premium Empty State -->
            <div class="premium-empty-state">
                <div class="empty-illustration-premium">
                    <div class="empty-decoration">
                        <div class="decoration-circle"></div>
                        <div class="decoration-circle"></div>
                    </div>
                    <div class="empty-icon-container">
                        <ion-icon name="cube-outline" class="empty-icon-premium"></ion-icon>
                    </div>
                </div>
                <h3 class="empty-title">No Products in Inventory</h3>
                <p class="empty-description">Start building your inventory by adding your first product</p>
                <div class="empty-actions">
                    <button class="premium-empty-action" onclick="window.location.href='/items/add'">
                        <ion-icon name="add-outline"></ion-icon>
                        Add Your First Product
                    </button>
                    
                </div>
            </div>
        <% } %>
    </div>
</div>

<script>
// Utility functions
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Global variables
let selectedProducts = [];
let currentPage = 1;
let itemsPerPage = <%= initialLimit %>;

// Infinite scrolling variables
let isInfiniteScroll = false;
let infiniteScrollOffset = 0;
let infiniteScrollHasMore = true;
let infiniteScrollLoading = false;
let totalItemsLoaded = 0;
let observer = null;

// URL parameter handling removed - using infinite scroll only

// Advanced Fuzzy Search functionality
window.handleSearch = debounce(async (value) => {
    const searchClearBtn = document.querySelector('.search-clear');
    const searchContainer = document.querySelector('.search-box-modern');
    
    if (searchClearBtn) {
        searchClearBtn.style.display = value.length > 0 ? 'block' : 'none';
    }
    
    if (value.length > 1) {
        await performFuzzySearch(value);
    } else {
        hideSuggestions();
    }
}, 300);

// Fuzzy search with Apple-style suggestions
async function performFuzzySearch(query) {
    try {
        const response = await fetch(`/storage/api/search-suggestions?query=${encodeURIComponent(query)}&limit=8`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        displaySuggestions(data.suggestions || [], query);
        
    } catch (error) {
        console.error('Search error:', error);
        hideSuggestions();
    }
}

// Display Apple-style suggestion dropdown
function displaySuggestions(suggestions, query) {
    const existingDropdown = document.getElementById('search-suggestions-dropdown');
    if (existingDropdown) {
        existingDropdown.remove();
    }
    
    if (suggestions.length === 0) {
        hideSuggestions();
        return;
    }
    
    const searchInput = document.getElementById('globalSearch');
    const searchContainer = document.querySelector('.search-box-modern');
    
    if (!searchInput || !searchContainer) return;
    
    // Create dropdown
    const dropdown = document.createElement('div');
    dropdown.id = 'search-suggestions-dropdown';
    
    // Create suggestions HTML
    const suggestionsHTML = suggestions.map((suggestion, index) => `
        <div class="suggestion-item" data-product-id="${suggestion._id}" onclick="selectSuggestion('${suggestion._id}', '${suggestion.name.replace(/'/g, "\\'")}')">
            <div class="suggestion-name">
                ${suggestion.highlightText}
            </div>
            <div class="suggestion-details">
                ${suggestion.displayText}
            </div>
        </div>
    `).join('');

    dropdown.innerHTML = suggestionsHTML;
    // Position dropdown as fixed relative to viewport (not constrained by Inventory Controls)
    const inputRect = searchInput.getBoundingClientRect();
    
    dropdown.style.position = 'fixed';
    dropdown.style.top = `${inputRect.bottom + 8}px`;
    dropdown.style.left = `${inputRect.left}px`;
    dropdown.style.right = `${window.innerWidth - inputRect.right}px`;
    dropdown.style.minWidth = '300px';
    dropdown.style.maxWidth = '500px';
    dropdown.style.zIndex = '9999';
    
    // Add to body to escape Inventory Controls container
    document.body.appendChild(dropdown);
    
    // Add event listeners
    addSuggestionEventListeners();
}

// Hide suggestions dropdown
function hideSuggestions() {
    const dropdown = document.getElementById('search-suggestions-dropdown');
    if (dropdown) {
        dropdown.remove();
    }
}

// Add event listeners for suggestion interactions
function addSuggestionEventListeners() {
    const dropdown = document.getElementById('search-suggestions-dropdown');
    if (!dropdown) return;
    
    // Close on click outside
    document.addEventListener('click', function handleOutsideClick(e) {
        if (!dropdown.contains(e.target) && !document.getElementById('globalSearch').contains(e.target)) {
            hideSuggestions();
            document.removeEventListener('click', handleOutsideClick);
        }
    });
    
    // Keyboard navigation
    const searchInput = document.getElementById('globalSearch');
    searchInput.addEventListener('keydown', function(e) {
        const suggestions = dropdown.querySelectorAll('.suggestion-item');
        const currentActive = dropdown.querySelector('.suggestion-item.active');
        
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            if (currentActive) {
                currentActive.classList.remove('active');
                const next = currentActive.nextElementSibling;
                if (next) next.classList.add('active');
                else suggestions[0].classList.add('active');
            } else if (suggestions.length > 0) {
                suggestions[0].classList.add('active');
            }
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            if (currentActive) {
                currentActive.classList.remove('active');
                const prev = currentActive.previousElementSibling;
                if (prev) prev.classList.add('active');
                else suggestions[suggestions.length - 1].classList.add('active');
            } else if (suggestions.length > 0) {
                suggestions[suggestions.length - 1].classList.add('active');
            }
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (currentActive) {
                currentActive.click();
            } else if (suggestions.length > 0) {
                suggestions[0].click();
            }
        } else if (e.key === 'Escape') {
            hideSuggestions();
        }
    });
}

// Select a suggestion
window.selectSuggestion = function(productId, productName) {
    hideSuggestions();
    
    // Navigate to product details
    window.location.href = `/items/get/${productId}`;
}

// View all search results
window.viewAllResults = function(query) {
    hideSuggestions();
    
    // Use the existing filter system with search term
    const params = new URLSearchParams({
        search: query,
        limit: '50'
    });
    window.location.href = `/storage/filter?${params.toString()}`;
}

// Filter functionality - now supports all filter combinations
function applyFilters() {
    const sort = document.getElementById('sortFilter')?.value;
    const size = document.getElementById('sizeFilter')?.value;
    const category = document.getElementById('categoryFilter')?.value;
    const stock = document.getElementById('stockFilter')?.value;
    const price = document.getElementById('priceFilter')?.value;
    
    // Build query parameters for the new filter route
    const params = new URLSearchParams();
    
    if (sort) params.append('sort', sort);
    if (size) params.append('size', size);
    if (category) params.append('category', category);
    if (stock) params.append('stock', stock); // Note: backend expects 'stock' but we renamed variable to avoid conflicts
    if (price) params.append('price', price);
    
    // Always include limit for consistent pagination
    params.append('limit', '50');
    
    // Navigate to the new comprehensive filter route
    const url = `/storage/filter?${params.toString()}`;
    window.location.href = url;
}

window.clearSearch = function() {
    const searchInput = document.getElementById('globalSearch');
    const searchClearBtn = document.querySelector('.search-clear');
    
    if (searchInput) searchInput.value = '';
    if (searchClearBtn) searchClearBtn.style.display = 'none';
    
    // Hide suggestions and reset to default view
    hideSuggestions();
    window.location.href = '/storage';
}

// View switching
window.switchView = function(view) {
    const buttons = document.querySelectorAll('.view-btn');
    buttons.forEach(btn => btn.classList.remove('active'));
    
    const activeBtn = document.querySelector(`[data-view="${view}"]`);
    if (activeBtn) {
        activeBtn.classList.add('active');
    }
    
    const grid = document.getElementById('productsGrid');
    if (grid) {
        switch(view) {
            case 'list':
                grid.style.gridTemplateColumns = '1fr';
                grid.className = 'products-container list-view';
                break;
            case 'compact':
                grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(200px, 1fr))';
                grid.className = 'products-container compact-view';
                break;
            default: // grid
                grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(320px, 1fr))';
                grid.className = 'products-container grid-view';
                break;
        }
    }
}

// Quick filter functions - now using the new filter system
window.filterLowStock = function() {
    const params = new URLSearchParams({
        stock: 'low-stock',
        limit: '50'
    });
    window.location.href = `/storage/filter?${params.toString()}`;
}

window.filterOutOfStock = function() {
    const params = new URLSearchParams({
        stock: 'out-of-stock',
        limit: '50'
    });
    window.location.href = `/storage/filter?${params.toString()}`;
}



// Filter actions
window.resetAllFilters = function() {
    window.location.href = '/storage';
}



// Product selection
function toggleProductSelection(productId) {
    const checkbox = document.getElementById(`select-${productId}`);
    if (checkbox.checked) {
        if (!selectedProducts.includes(productId)) {
            selectedProducts.push(productId);
        }
    } else {
        selectedProducts = selectedProducts.filter(id => id !== productId);
    }
    updateBulkActionsVisibility();
}

function updateBulkActionsVisibility() {
    const bulkActionsBtn = document.querySelector('.btn-bulk');
    if (bulkActionsBtn) {
        bulkActionsBtn.style.display = selectedProducts.length > 0 ? 'flex' : 'none';
    }
}

// Product actions
window.editProduct = function(id) {
    window.location.href = `/items/edit/${id}`;
}

window.viewProduct = function(id) {
    window.location.href = `/items/get/${id}`;
}



window.manageStock = function(id) {
    // Stock management functionality
    console.log('Managing stock for product:', id);
    // Could open a modal or navigate to stock management page
}

window.quickSell = function(id) {
    // Quick sell functionality
    console.log('Quick sell product:', id);
    // Could open a quick sell modal
}

window.deleteProduct = function(id) {
    Swal.fire({
        title: 'Delete Product',
        text: 'Are you sure you want to delete this product? This action cannot be undone.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Yes, delete it!'
    }).then((result) => {
        if (result.isConfirmed) {
            // Perform delete action
            console.log('Deleting product:', id);
        }
    });
}



window.exportInventory = async function() {
    try {
        // Show loading state
        Swal.fire({
            title: 'Exporting Inventory...',
            text: 'Please wait while we generate your CSV file',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading()
            }
        });

        // Fetch all products for export
        const response = await fetch('/storage/api/export');
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.products && data.products.length > 0) {
            // Convert to CSV
            const csv = convertToCSV(data.products);
            
            // Create and download file
            downloadCSV(csv, 'inventory-export.csv');
            
            Swal.fire({
                icon: 'success',
                title: 'Export Complete!',
                text: `${data.products.length} products exported successfully`,
                timer: 2000,
                showConfirmButton: false
            });
            
            console.log(`Exported ${data.products.length} products to CSV`);
        } else {
            Swal.fire({
                icon: 'info',
                title: 'No Data to Export',
                text: 'No products found to export'
            });
        }
        
    } catch (error) {
        console.error('Export error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Export Failed',
            text: 'Failed to export inventory data. Please try again.'
        });
    }
}

function convertToCSV(products) {
    // Define CSV headers
    const headers = [
        'SKU',
        'Name', 
        'Category',
        'Color',
        'Size',
        'Cost Price (IQD)',
        'Selling Price (IQD)',
        'Main Storage Qty',
        'Store Qty',
        'Total Stock',
        'Potential Profit (IQD)',
        'Profit Margin (%)',
        'Status'
    ];
    
    // Convert products to CSV rows
    const rows = products.map(product => {
        const totalStock = (product.qty || 0) + (product.stock || 0);
        const profit = ((product.sell_price || 0) - (product.price || 0)) * totalStock;
        const profitMargin = product.price > 0 ? ((product.sell_price - product.price) / product.price * 100) : 0;
        const stockStatus = totalStock === 0 ? 'Out of Stock' : totalStock <= 10 ? 'Low Stock' : 'In Stock';
        
        return [
            product.sku || 'N/A',
            product.name || 'N/A',
            product.category || product.name || 'N/A',
            product.colorName || product.color || 'N/A',
            product.size || 'N/A',
            (product.price || 0).toLocaleString(),
            (product.sell_price || 0).toLocaleString(),
            product.qty || 0,
            product.stock || 0,
            totalStock,
            profit.toLocaleString(),
            profitMargin.toFixed(1),
            stockStatus
        ];
    });
    
    // Combine headers and rows
    const csvContent = [headers, ...rows]
        .map(row => row.map(field => `"${field}"`).join(','))
        .join('\n');
    
    return csvContent;
}

function downloadCSV(csvContent, filename) {
    // Create blob
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    
    // Create download link
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', filename);
    link.style.visibility = 'hidden';
    
    // Add to document, click, and remove
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}



function showImportDialog() {
    // Show import dialog
    console.log('Show import dialog');
}

// Pagination functions removed - using infinite scroll only

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Set initial view
    const initialView = 'grid';
    switchView(initialView);
    
    // Maintain filter state from URL parameters
    maintainFilterState();
    
    // Always enable infinite scroll for all users (50 items per scroll)
    updatePaginationInfoForAllItems();
    
    // Small delay to ensure DOM is fully loaded before enabling infinite scroll
    setTimeout(() => {
        enableInfiniteScroll();
    }, 1000);
    
    // CRITICAL: Load analytics immediately for accurate inventory statistics
    loadAnalyticsAsync();
    loadCategoriesAsync();
});

// Maintain filter state from URL parameters
function maintainFilterState() {
    const urlParams = new URLSearchParams(window.location.search);
    
    // Set filter dropdowns based on URL parameters
    const sortFilter = urlParams.get('sort');
    const sizeFilter = urlParams.get('size');
    const categoryFilter = urlParams.get('category');
    const stockFilter = urlParams.get('stock');
    const priceFilter = urlParams.get('price');
    const searchFilter = urlParams.get('search');
    
    // Maintain search input value
    if (searchFilter) {
        const searchInput = document.getElementById('globalSearch');
        if (searchInput) {
            searchInput.value = searchFilter;
            const searchClearBtn = document.querySelector('.search-clear');
            if (searchClearBtn) {
                searchClearBtn.style.display = 'block';
            }
        }
    }
    
    if (sortFilter) {
        const sortSelect = document.getElementById('sortFilter');
        if (sortSelect) sortSelect.value = sortFilter;
    }
    
    if (sizeFilter) {
        const sizeSelect = document.getElementById('sizeFilter');
        if (sizeSelect) sizeSelect.value = sizeFilter;
    }
    
    if (categoryFilter) {
        const categorySelect = document.getElementById('categoryFilter');
        if (categorySelect) categorySelect.value = categoryFilter;
    }
    
    if (stockFilter) {
        const stockSelect = document.getElementById('stockFilter');
        if (stockSelect) stockSelect.value = stockFilter;
    }
    
    if (priceFilter) {
        const priceSelect = document.getElementById('priceFilter');
        if (priceSelect) priceSelect.value = priceFilter;
    }
}

// OPTIMIZED: Lazy load analytics data
async function loadAnalyticsAsync() {
    try {
        console.log('Loading analytics asynchronously...');
        const response = await fetch('/storage/api/analytics');
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.analytics) {
            updateDashboardStats(data.analytics);
            console.log('Analytics loaded successfully');
        }
        
    } catch (error) {
        console.error('Error loading analytics:', error);
        // Fallback: keep existing stats or show loading state
    }
}

// OPTIMIZED: Lazy load categories data
async function loadCategoriesAsync() {
    try {
        console.log('Loading categories asynchronously...');
        const response = await fetch('/storage/api/categories');
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.categories) {
            updateCategoryFilter(data.categories);
            console.log('Categories loaded successfully');
        }
        
    } catch (error) {
        console.error('Error loading categories:', error);
        // Fallback: categories will load with initial page data
    }
}

// COMPREHENSIVE: Update dashboard statistics with all enhanced analytics
function updateDashboardStats(analytics) {
    // Update stat cards with new data
    const statCards = document.querySelectorAll('.stat-card');
    
    statCards.forEach(card => {
        const title = card.querySelector('.stat-title')?.textContent;
        
        switch(title) {
            case 'Total Products':
                const totalValueEl = card.querySelector('.stat-value');
                if (totalValueEl && analytics.totalProducts !== undefined) {
                    totalValueEl.textContent = analytics.totalProducts.toLocaleString();
                }
                break;
                
            case 'Total Value':
                const valueEl = card.querySelector('.stat-value');
                if (valueEl && analytics.totalPotentialRevenue !== undefined) {
                    valueEl.textContent = `IQD ${analytics.totalPotentialRevenue.toLocaleString()}`;
                }
                break;
                
            case 'Low Stock':
                const lowStockEl = card.querySelector('.stat-value');
                if (lowStockEl && analytics.lowStockItems !== undefined) {
                    lowStockEl.textContent = analytics.lowStockItems.toLocaleString();
                }
                break;
                
            case 'Average Price':
                const avgPriceEl = card.querySelector('.stat-value');
                if (avgPriceEl && analytics.avgSellPrice !== undefined) {
                    avgPriceEl.textContent = `IQD ${analytics.avgSellPrice.toLocaleString()}`;
                }
                break;

            // Enhanced metrics for superior dashboard
            case 'Out of Stock':
                const outOfStockEl = card.querySelector('.stat-value');
                if (outOfStockEl && analytics.outOfStockItems !== undefined) {
                    outOfStockEl.textContent = analytics.outOfStockItems.toLocaleString();
                }
                break;

            case 'Potential Profit':
                const potentialProfitEl = card.querySelector('.stat-value');
                if (potentialProfitEl && analytics.totalPotentialProfit !== undefined) {
                    potentialProfitEl.textContent = `IQD ${analytics.totalPotentialProfit.toLocaleString()}`;
                }
                break;

            case 'Total Categories':
                const categoriesEl = card.querySelector('.stat-value');
                if (categoriesEl && analytics.totalCategories !== undefined) {
                    categoriesEl.textContent = analytics.totalCategories.toLocaleString();
                }
                break;

            case 'Reorder Alerts':
                const reorderEl = card.querySelector('.stat-value');
                if (reorderEl && analytics.reorderAlertItems !== undefined) {
                    reorderEl.textContent = analytics.reorderAlertItems.toLocaleString();
                }
                break;

            case 'High Value Items':
                const highValueEl = card.querySelector('.stat-value');
                if (highValueEl && analytics.highValueItems !== undefined) {
                    highValueEl.textContent = analytics.highValueItems.toLocaleString();
                }
                break;
        }
    });
}

// Update category filter with loaded categories
function updateCategoryFilter(categories) {
    const categoryFilter = document.getElementById('categoryFilter');
    if (!categoryFilter) return;
    
    // Only update if we don't have categories yet (check if "All Categories" is the only option)
    const currentOptions = categoryFilter.querySelectorAll('option');
    if (currentOptions.length <= 1) {
        // Clear existing options except "All Categories"
        const allCategoriesOption = categoryFilter.querySelector('option[value=""]');
        categoryFilter.innerHTML = '';
        if (allCategoriesOption) {
            categoryFilter.appendChild(allCategoriesOption);
        }
        
        // Add loaded categories
        categories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.name;
            option.textContent = cat.name;
            categoryFilter.appendChild(option);
        });
        
        console.log(`Updated category filter with ${categories.length} categories`);
    }
}

// Update pagination info when showing all items
function updatePaginationInfoForAllItems() {
    const showingFrom = document.getElementById('showingFrom');
    const showingTo = document.getElementById('showingTo');
    const totalItems = document.getElementById('totalItems');
    
    if (totalItems) {
        const total = parseInt(totalItems.textContent) || 0;
        if (showingFrom) showingFrom.textContent = '1';
        if (showingTo) showingTo.textContent = total.toString();
    }
}

// Infinite Scrolling Functions
function enableInfiniteScroll() {
    if (isInfiniteScroll) return; // Already enabled
    
    isInfiniteScroll = true;
    infiniteScrollOffset = <%= products ? products.length : 0 %>;
    totalItemsLoaded = infiniteScrollOffset;
    
    // Create and add loading indicator
    createLoadingIndicator();
    
    // Initialize Intersection Observer
    initInfiniteScrollObserver();
    
    // Hide pagination controls for infinite scroll mode
    const paginationContainer = document.querySelector('.pagination-container');
    if (paginationContainer) {
        paginationContainer.style.display = 'none';
    }
    
    // Update pagination info to show current loaded count
    updateInfiniteScrollInfo();
    
    console.log(`Infinite scroll enabled. Initial page: 24 items. Will load 50 more per scroll for complete inventory.`);
}

function updateInfiniteScrollInfo() {
    const showingFrom = document.getElementById('showingFrom');
    const showingTo = document.getElementById('showingTo');
    const totalItems = document.getElementById('totalItems');
    
    if (showingFrom && showingTo && totalItems) {
        showingFrom.textContent = '1';
        showingTo.textContent = totalItemsLoaded.toString();
        
        // Update the text to indicate infinite scroll mode
        const paginationInfo = document.querySelector('.pagination-info');
        if (paginationInfo) {
            paginationInfo.innerHTML = `
                Showing <span id="showingFrom">1</span> to <span id="showingTo">${totalItemsLoaded}</span> of <span id="totalItems">${totalItemsLoaded}</span> items
                <span class="infinite-scroll-notice" style="color: #007AFF; font-size: 12px; margin-left: 10px;">
                     Scroll to load more
                </span>
            `;
        }
    }
}

function disableInfiniteScroll() {
    if (!isInfiniteScroll) return; // Already disabled
    
    isInfiniteScroll = false;
    
    // Clean up observer
    if (observer) {
        observer.disconnect();
        observer = null;
    }
    
    // Remove loading indicator
    removeLoadingIndicator();
    
    // Show pagination controls
    const paginationContainer = document.querySelector('.pagination-container');
    if (paginationContainer) {
        paginationContainer.style.display = 'block';
    }
    
    console.log('Infinite scroll disabled');
}

function initInfiniteScrollObserver() {
    // Create sentinel element for Intersection Observer
    const sentinel = document.createElement('div');
    sentinel.id = 'infinite-scroll-sentinel';
    sentinel.style.height = '1px';
    sentinel.style.width = '100%';
    
    // Add sentinel to the products container
    const productsGrid = document.getElementById('productsGrid');
    if (productsGrid) {
        productsGrid.appendChild(sentinel);
    }
    
    // Create Intersection Observer
    observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting && !infiniteScrollLoading && infiniteScrollHasMore) {
                loadMoreProducts();
            }
        });
    }, {
        rootMargin: '100px' // Start loading before reaching the bottom
    });
    
    // Observe the sentinel
    observer.observe(sentinel);
}

function createLoadingIndicator() {
    // Remove existing loading indicator if any
    removeLoadingIndicator();
    
    const loadingIndicator = document.createElement('div');
    loadingIndicator.id = 'infinite-scroll-loading';
    loadingIndicator.className = 'infinite-scroll-loading';
    loadingIndicator.innerHTML = `
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <span class="loading-text">Loading 50 more products...</span>
            <div class="loading-progress">
                <span id="loadedCount">${totalItemsLoaded}</span> items loaded
            </div>
        </div>
    `;
    
    // Add styles for loading indicator
    const style = document.createElement('style');
    style.textContent = `
        .infinite-scroll-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px 20px;
            margin: 20px 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .loading-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }
        
        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007AFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: #1d1d1f;
            font-weight: 500;
            font-size: 14px;
        }
        
        .loading-progress {
            color: #8e8e93;
            font-size: 12px;
        }
        
        #loadedCount {
            font-weight: 600;
            color: #007AFF;
        }
        
        /* Scroll notice styling */
        .items-per-page .scroll-notice {
            color: #007AFF;
            font-size: 13px;
            font-weight: 500;
            background: rgba(0, 122, 255, 0.1);
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid rgba(0, 122, 255, 0.2);
        }
    `;
    document.head.appendChild(style);
    
    // Insert after products container
    const productsGrid = document.getElementById('productsGrid');
    if (productsGrid) {
        productsGrid.parentNode.insertBefore(loadingIndicator, productsGrid.nextSibling);
    }
}

function removeLoadingIndicator() {
    const existingLoading = document.getElementById('infinite-scroll-loading');
    if (existingLoading) {
        existingLoading.remove();
    }
}

async function loadMoreProducts() {
    if (infiniteScrollLoading || !infiniteScrollHasMore) {
        return;
    }
    
    infiniteScrollLoading = true;
    
    try {
        // Show loading state
        updateLoadingIndicator(true);
        
        // Get current filter values for infinite scroll
        const searchTerm = document.getElementById('globalSearch')?.value || '';
        const category = document.getElementById('categoryFilter')?.value || '';
        const sortFilter = document.getElementById('sortFilter')?.value || '';
        const size = document.getElementById('sizeFilter')?.value || '';
        const stock = document.getElementById('stockFilter')?.value || '';
        const price = document.getElementById('priceFilter')?.value || '';
        
        // Parse sort field and order
        let sortField = 'Date';
        let sortOrder = 'desc';
        
        if (sortFilter) {
            switch(sortFilter) {
                case 'qty-most':
                    sortField = 'qty';
                    sortOrder = 'desc';
                    break;
                case 'qty-less':
                    sortField = 'qty';
                    sortOrder = 'asc';
                    break;
                case 'price-most':
                    sortField = 'sell_price';
                    sortOrder = 'desc';
                    break;
                case 'price-less':
                    sortField = 'sell_price';
                    sortOrder = 'asc';
                    break;
                case 'name-asc':
                    sortField = 'name';
                    sortOrder = 'asc';
                    break;
                case 'name-desc':
                    sortField = 'name';
                    sortOrder = 'desc';
                    break;
                case 'profit-desc':
                    sortField = 'sell_price';
                    sortOrder = 'desc';
                    break;
                case 'profit-asc':
                    sortField = 'sell_price';
                    sortOrder = 'asc';
                    break;
                case 'updated-desc':
                    sortField = 'Date';
                    sortOrder = 'desc';
                    break;
            }
        }
        
        // Build API URL with all filter parameters for infinite scroll
        const params = new URLSearchParams({
            offset: infiniteScrollOffset.toString(),
            limit: '50', // Load 50 items per scroll chunk for better performance
            search: searchTerm,
            category: category,
            sortField: sortField,
            sortOrder: sortOrder,
            size: size,
            stockStatus: stock, // Use stockStatus to match backend parameter name
            price: price,
            sort: sortFilter // Also pass the sort filter for enhanced sorting
        });
        
        const response = await fetch(`/storage/api/infinite-scroll?${params.toString()}`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.products && data.products.length > 0) {
            // Append new products to the grid
            appendProductsToGrid(data.products);
            
            // Update state
            infiniteScrollOffset = data.nextOffset;
            infiniteScrollHasMore = data.hasMore;
            totalItemsLoaded = data.currentOffset + data.loadedCount;
            
            // Update loading indicator
            updateLoadingIndicator(false, data.hasMore);
            
            console.log(`Loaded ${data.products.length} more products. Total loaded: ${totalItemsLoaded}`);
        } else {
            // No more products
            infiniteScrollHasMore = false;
            updateLoadingIndicator(false, false);
            console.log('No more products to load');
        }
        
    } catch (error) {
        console.error('Error loading more products:', error);
        updateLoadingIndicator(false, true, true);
        
        // Show error message to user
        showErrorMessage('Failed to load more products. Please try again.');
    } finally {
        infiniteScrollLoading = false;
    }
}

function appendProductsToGrid(products) {
    const productsGrid = document.getElementById('productsGrid');
    if (!productsGrid || !products || products.length === 0) return;
    
    // Create HTML for new products
    const productsHTML = products.map(product => {
        const totalStock = (product.qty || 0) + (product.stock || 0);
        const profit = ((product.sell_price || 0) - (product.price || 0)) * totalStock;
        const profitMargin = product.price > 0 ? ((product.sell_price - product.price) / product.price * 100) : 0;
        const stockStatus = totalStock === 0 ? 'out-of-stock' : totalStock <= 10 ? 'low-stock' : 'in-stock';
        
        // Construct image path
        let imagePath = product.image;
        if (imagePath && !imagePath.startsWith('/upload/images/')) {
            imagePath = '/upload/images/' + imagePath;
        }
        
        return `
            <div class="product-card-modern" data-product-id="${product._id}">
                <!-- Product Selection Checkbox -->
                <div class="product-checkbox">
                    <input type="checkbox" id="select-${product._id}" onchange="toggleProductSelection('${product._id}')">
                    <label for="select-${product._id}"></label>
                </div>
                
                <!-- Product Image Section -->
                <div class="product-image-section">
                    <div class="image-container">
                        ${imagePath && imagePath !== 'none' && imagePath.trim() !== '' ? `
                            <img src="${imagePath}" alt="${product.name}" class="product-image" 
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                            <div class="no-image-placeholder" style="display: none;">
                                <ion-icon name="image-outline"></ion-icon>
                            </div>
                        ` : `
                            <div class="no-image-placeholder">
                                <ion-icon name="image-outline"></ion-icon>
                            </div>
                        `}
                        
                        <!-- Status Badge -->
                        <div class="status-badge ${stockStatus}">
                            ${stockStatus === 'out-of-stock' ? `
                                <ion-icon name="close-circle-outline"></ion-icon>
                                <span>Out of Stock</span>
                            ` : stockStatus === 'low-stock' ? `
                                <ion-icon name="warning-outline"></ion-icon>
                                <span>Low Stock</span>
                            ` : `
                                <ion-icon name="checkmark-circle-outline"></ion-icon>
                                <span>In Stock</span>
                            `}
                        </div>
                        
                        <!-- Quick Actions Overlay -->
                        <div class="quick-actions-overlay">
                            <button class="quick-action" onclick="event.stopPropagation(); viewProduct('${product._id}')" title="View Details">
                                <ion-icon name="eye-outline"></ion-icon>
                            </button>
                            <button class="quick-action" onclick="event.stopPropagation(); editProduct('${product._id}')" title="Edit Product">
                                <ion-icon name="create-outline"></ion-icon>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Product Information -->
                <div class="product-info-section">
                    <div class="product-header">
                        <h3 class="product-name" title="${product.name}">${product.name}</h3>
                        <div class="product-sku">SKU: ${product.sku || 'N/A'}</div>
                    </div>
                    
                    <!-- Product Variants -->
                    <div class="product-variants">
                        ${product.colorName || product.color ? `
                            <div class="variant-item">
                                <span class="variant-label">Color:</span>
                                <div class="color-info">
                                    ${product.colorHex ? `<div class="color-dot" style="background-color: ${product.colorHex}"></div>` : ''}
                                    <span class="variant-value">${product.colorName || product.color}</span>
                                </div>
                            </div>
                        ` : ''}
                        ${product.size ? `
                            <div class="variant-item">
                                <span class="variant-label">Size:</span>
                                <span class="variant-value size-badge">${product.size}</span>
                            </div>
                        ` : ''}
                        ${product.category || product.name ? `
                            <div class="variant-item">
                                <span class="variant-label">Category:</span>
                                <span class="variant-value category-badge">${product.category || product.name}</span>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Stock Information -->
                    <div class="stock-section">
                        <div class="stock-header">
                            <span class="stock-title">Inventory</span>
                            <div class="stock-total-display">
                                <span class="total-label">Total:</span>
                                <span class="total-value ${stockStatus}">${totalStock}</span>
                            </div>
                        </div>
                        
                        <div class="stock-breakdown">
                            <div class="stock-location">
                                <span class="location-label">Main Storage</span>
                                <span class="location-value">${product.qty || 0}</span>
                            </div>
                            <div class="stock-location">
                                <span class="location-label">Store</span>
                                <span class="location-value">${product.stock || 0}</span>
                            </div>
                        </div>
                        
                        <!-- Stock Progress Bar -->
                        <div class="stock-progress">
                            <div class="progress-bar">
                                <div class="progress-fill ${stockStatus}" style="width: ${Math.min((totalStock / 50) * 100, 100)}%"></div>
                            </div>
                            <span class="progress-text">${totalStock} / 50 units</span>
                        </div>
                    </div>
                    
                    <!-- Pricing Information -->
                    <div class="pricing-section">
                        <div class="price-grid">
                            <div class="price-item">
                                <span class="price-label">Cost Price</span>
                                <span class="price-value cost">IQD ${(product.price || 0).toLocaleString()}</span>
                            </div>
                            <div class="price-item">
                                <span class="price-label">Selling Price</span>
                                <span class="price-value selling">IQD ${(product.sell_price || 0).toLocaleString()}</span>
                            </div>
                        </div>
                        
                        ${profit > 0 ? `
                            <div class="profit-section">
                                <div class="profit-info">
                                    <span class="profit-label">Potential Profit</span>
                                    <span class="profit-value">IQD ${profit.toLocaleString()}</span>
                                </div>
                                <div class="profit-margin">
                                    <span class="margin-label">Margin:</span>
                                    <span class="margin-value ${profitMargin >= 50 ? 'high' : profitMargin >= 20 ? 'medium' : 'low'}">
                                        ${profitMargin.toFixed(1)}%
                                    </span>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="product-actions">
                    <button class="action-btn primary" onclick="event.stopPropagation(); editProduct('${product._id}')">
                        <ion-icon name="create-outline"></ion-icon>
                        <span>Edit</span>
                    </button>
                    <button class="action-btn secondary" onclick="event.stopPropagation(); manageStock('${product._id}')">
                        <ion-icon name="barcode-outline"></ion-icon>
                        <span>Stock</span>
                    </button>
                    <button class="action-btn tertiary" onclick="event.stopPropagation(); quickSell('${product._id}')">
                        <ion-icon name="cash-outline"></ion-icon>
                        <span>Sell</span>
                    </button>
                    <button class="action-btn danger" onclick="event.stopPropagation(); deleteProduct('${product._id}')">
                        <ion-icon name="trash-outline"></ion-icon>
                    </button>
                </div>
            </div>
        `;
    }).join('');
    
    // Insert before the sentinel
    const sentinel = document.getElementById('infinite-scroll-sentinel');
    if (sentinel) {
        sentinel.insertAdjacentHTML('beforebegin', productsHTML);
    } else {
        productsGrid.insertAdjacentHTML('beforeend', productsHTML);
    }
}

function updateLoadingIndicator(loading, hasMore = true, isError = false) {
    const loadingIndicator = document.getElementById('infinite-scroll-loading');
    if (!loadingIndicator) return;
    
    const loadedCountSpan = document.getElementById('loadedCount');
    const loadingText = loadingIndicator.querySelector('.loading-text');
    
    if (loadedCountSpan) {
        loadedCountSpan.textContent = totalItemsLoaded.toString();
    }
    
    if (loading) {
        loadingText.textContent = 'Loading 50 more products...';
        loadingIndicator.style.opacity = '1';
    } else if (isError) {
        loadingText.textContent = 'Failed to load more products';
        loadingText.style.color = '#ff3b30';
        
        // Add retry button
        const retryBtn = document.createElement('button');
        retryBtn.textContent = 'Retry';
        retryBtn.className = 'retry-btn';
        retryBtn.style.cssText = `
            background: #ff3b30;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 8px;
        `;
        retryBtn.onclick = () => {
            loadingText.textContent = 'Loading 50 more products...';
            loadingText.style.color = '#1d1d1f';
            retryBtn.remove();
            loadMoreProducts();
        };
        
        if (!loadingIndicator.querySelector('.retry-btn')) {
            loadingIndicator.querySelector('.loading-content').appendChild(retryBtn);
        }
    } else if (!hasMore) {
        loadingText.textContent = 'All products loaded';
        loadingText.style.color = '#8e8e93';
        
        // Remove the loading indicator after a delay
        setTimeout(() => {
            removeLoadingIndicator();
        }, 2000);
    } else {
        loadingText.textContent = 'Ready to load more';
        loadingText.style.color = '#8e8e93';
        
        // Hide the loading indicator after a delay
        setTimeout(() => {
            loadingIndicator.style.opacity = '0.5';
        }, 1000);
    }
}

function showErrorMessage(message) {
    // Create temporary error notification
    const errorDiv = document.createElement('div');
    errorDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #ff3b30;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        z-index: 1000;
        font-size: 14px;
        box-shadow: 0 4px 12px rgba(255, 59, 48, 0.3);
        animation: slideIn 0.3s ease-out;
    `;
    errorDiv.textContent = message;
    
    document.body.appendChild(errorDiv);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        errorDiv.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => errorDiv.remove(), 300);
    }, 3000);

<style>
/* Super Professional and Clean Search Suggestions Dropdown */
.search-suggestions-dropdown {
    position: fixed;
    z-index: 9999;
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 14px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.12), 0 2px 10px rgba(0, 0, 0, 0.08);
    max-height: 420px;
    overflow-y: auto;
    padding: 8px 0;
    animation: fadeIn 0.15s ease-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-4px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.search-suggestions-dropdown::-webkit-scrollbar {
    width: 6px;
}

.search-suggestions-dropdown::-webkit-scrollbar-track {
    background: transparent;
}

.search-suggestions-dropdown::-webkit-scrollbar-thumb {
    background: #d1d5db;
    border-radius: 3px;
}

.search-suggestions-dropdown::-webkit-scrollbar-thumb:hover {
    background: #9ca3af;
}

.search-suggestions-dropdown .suggestion-item {
    padding: 14px 18px;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    gap: 4px;
    transition: all 0.15s ease;
    border-left: 3px solid transparent;
    margin: 0 4px;
    border-radius: 10px;
}

.search-suggestions-dropdown .suggestion-item:hover {
    background: #f9fafb;
    border-left-color: #3b82f6;
}

.search-suggestions-dropdown .suggestion-item.active {
    background: #eff6ff;
    border-left-color: #3b82f6;
}

.search-suggestions-dropdown .suggestion-name {
    font-size: 14px;
    font-weight: 500;
    color: #111827;
    line-height: 1.4;
}

.search-suggestions-dropdown .suggestion-name mark {
    background: #dbeafe;
    color: #1e40af;
    padding: 1px 2-radius: 3px;
    borderpx;
    font-weight: 600;
}

.search-suggestions-dropdown .suggestion-details {
    font-size: 12px;
    color: #6b7280;
    font-weight: 400;
    line-height: 1.3;
}

.search-suggestions-dropdown .suggestion-item:hover .suggestion-name {
    color: #1f2937;
}

.search-suggestions-dropdown .suggestion-item:hover .suggestion-details {
    color: #4b5563;
}
</style>

</script>

<%- include('../layout/footer') -%>