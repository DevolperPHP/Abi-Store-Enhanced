<%- include("../layout/navbar") -%>

<div class="cashier-content">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title">Store Storage</h1>
        <p class="page-subtitle">Manage and monitor inventory levels</p>
    </div>

    <!-- Search and Filter Section -->
    <div class="modern-card">
        <div class="modern-card-header">
            <div>
                <h3 class="modern-card-title">Search & Filter</h3>
                <p class="modern-card-subtitle">Find products and filter by various criteria</p>
            </div>
        </div>

        <div class="action-bar">
            <div class="search-box" style="flex: 1;">
                <ion-icon name="barcode-outline"></ion-icon>
                <input id="searchInput" autocomplete="off" type="text" placeholder="Enter barcode">
            </div>
            <div class="search-box" style="flex: 1;">
                <ion-icon name="search-outline"></ion-icon>
                <input id="myInput" type="text" placeholder="Search for item by name" autocomplete="off">
            </div>
            <form id="searchForm" action="" method="get" style="display: none;">
            </form>
        </div>

        <div class="action-bar" style="margin-top: 16px;">
            <select onchange="redirectToPage(this)" class="form-control" style="max-width: 250px;">
                <option value="/" selected>Filter by Quantity</option>
                <option value="/localstore/storage">Cancel filter</option>
                <option value="/localstore/storage/filter/most">Quantity (Most)</option>
                <option value="/localstore/storage/filter/less">Quantity (Less)</option>
            </select>
            <select onchange="redirectToPage(this)" class="form-control" style="max-width: 250px;">
                <option value="/localstore/storage" selected>Filter by Size</option>
                <option value="/localstore/storage">Cancel filter</option>
                <% size.forEach(data=> {%>
                    <option value="/localstore/storage/size/<%= data.size%>">
                        <%= data.size%>
                    </option>
                <%}) %>
            </select>
        </div>
    </div>

    <!-- Storage Table -->
    <div class="modern-card">
        <div class="modern-card-header">
            <div>
                <h3 class="modern-card-title">Inventory</h3>
                <p class="modern-card-subtitle"><%= items.length %> product(s) found</p>
            </div>
        </div>

        <% if(items.length > 0) { %>
            <div style="overflow-x: auto;">
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Size</th>
                            <th>Color</th>
                            <th>Store Qty</th>
                            <th>Main Storage</th>
                            <th>Price</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% for (let i = 0; i < items.length; i++) { %>
                            <tr onclick="window.location.href='/localstore/storage/search/<%= items[i].barcode%>'" style="cursor: pointer;">
                                <td><%= items[i].name%></td>
                                <td><%= items[i].size%></td>
                                <td><%= items[i].colorName%></td>
                                <td>
                                    <% if(items[i].stock == null){%>
                                        <span class="status-badge status-error">Out of Stock</span>
                                    <%} else if(items[i].stock < 10) { %>
                                        <span class="status-badge status-pending"><%= items[i].stock%> (Low)</span>
                                    <%} else {%>
                                        <span class="status-badge status-success"><%= items[i].stock%></span>
                                    <%} %>
                                </td>
                                <td><%= items[i].qty%></td>
                                <td><%= items[i].sell_price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")%> IQD</td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        <% } else { %>
            <div style="text-align: center; padding: 48px 24px; color: var(--text-secondary);">
                <ion-icon name="cube-outline" style="font-size: 64px; opacity: 0.3;"></ion-icon>
                <p style="margin-top: 16px; font-size: 16px;">No products found. Try adjusting your search or filters.</p>
            </div>
        <% } %>
    </div>
</div>

<script>
    const form = document.getElementById("searchForm");
    const searchInput = document.getElementById("searchInput");

    form.addEventListener("submit", function (event) {
        const inputValue = searchInput.value;
        form.action = `/localstore/storage/search/${inputValue}`;
    });

    form.addEventListener("keydown", function (event) {
        if (event.key === "Enter") {
            event.preventDefault();
            const inputValue = event.target.value;
            const form = document.getElementById("searchForm");
            form.action = `/localstore/storage/search/${inputValue}`;
            form.submit();
        }
    });
</script>

<script>
    function redirectToPage(x) {
        window.location.href = `${x.value}`
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
<script>
    function autocomplete(inp, arr) {
        let currentFocus;
        const fuse = new Fuse(arr, {
            threshold: 0.4,
        });

        inp.addEventListener("input", function () {
            let a, b, val = this.value;
            closeAllLists();
            if (!val) return false;
            currentFocus = -1;

            a = document.createElement("DIV");
            a.setAttribute("id", this.id + "autocomplete-list");
            a.setAttribute("class", "autocomplete-items");
            this.parentNode.appendChild(a);

            const results = fuse.search(val);
            results.forEach(({ item }) => {
                b = document.createElement("DIV");
                b.innerHTML = `<strong>${item.substr(0, val.length)}</strong>${item.substr(val.length)}`;
                b.innerHTML += `<input type='hidden' value='${item}'>`;
                b.addEventListener("click", function () {
                    window.location.href = `/localstore/storage/search-by-name/${String(this.getElementsByTagName("input")[0].value)}`
                    closeAllLists();
                });
                a.appendChild(b);
            });
        });

        inp.addEventListener("keydown", function (e) {
            let x = document.getElementById(this.id + "autocomplete-list");
            if (x) x = x.getElementsByTagName("div");
            if (e.keyCode == 40) {
                currentFocus++;
                addActive(x);
            } else if (e.keyCode == 38) {
                currentFocus--;
                addActive(x);
            } else if (e.keyCode == 13) {
                e.preventDefault();
                if (currentFocus > -1 && x) x[currentFocus].click();
            }
        });

        function addActive(x) {
            if (!x) return false;
            removeActive(x);
            if (currentFocus >= x.length) currentFocus = 0;
            if (currentFocus < 0) currentFocus = x.length - 1;
            x[currentFocus].classList.add("autocomplete-active");
        }

        function removeActive(x) {
            for (let i = 0; i < x.length; i++) {
                x[i].classList.remove("autocomplete-active");
            }
        }

        function closeAllLists(elmnt) {
            const x = document.getElementsByClassName("autocomplete-items");
            for (let i = 0; i < x.length; i++) {
                if (elmnt != x[i] && elmnt != inp) {
                    x[i].parentNode.removeChild(x[i]);
                }
            }
        }

        document.addEventListener("click", function (e) {
            closeAllLists(e.target);
        });
    }

    const data = "<%= data %>".split(",");
    autocomplete(document.getElementById("myInput"), data);
</script>

<%- include("../layout/footer") -%>
