<%- include("../layout/navbar") -%>

<% if(err && err.length > 0){%>
    <script>
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: `<%= err%>`,
        })
    </script>
<%} %>

<%
    // Calculate original total and check for discount
    const originalTotal = data.products.map(x => x.total).reduce((a, b) => a + b, 0);
    const hasDiscount = Number(data.total) !== originalTotal;
    const discountAmount = hasDiscount ? originalTotal - Number(data.total) : 0;
%>

<div class="cashier-content">
    <!-- Page Header -->
    <div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 16px;">
        <div>
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                <a href="/localstore/orders" class="back-btn">
                    <ion-icon name="arrow-back-outline"></ion-icon>
                </a>
                <h1 class="page-title" style="margin: 0;">Order #<%= data.bid %></h1>
                <span class="order-status-badge <%= data.status === 'done' ? 'status-completed' : 'status-pending' %>">
                    <ion-icon name="<%= data.status === 'done' ? 'checkmark-circle' : 'time' %>"></ion-icon>
                    <%= data.status === 'done' ? 'Completed' : 'Pending' %>
                </span>
            </div>
            <p class="page-subtitle">Order details and management</p>
        </div>
        
    </div>

    <!-- Order Layout -->
    <div class="order-layout">
        <!-- Main Content -->
        <div class="order-main">
            <!-- Order Info Cards -->
            <div class="order-info-grid">
                <div class="info-card">
                    <div class="info-card-icon" style="background: rgba(0, 122, 255, 0.1); color: #007AFF;">
                        <ion-icon name="person-outline"></ion-icon>
                    </div>
                    <div class="info-card-content">
                        <span class="info-label">Cashier</span>
                        <span class="info-value"><%= data.name %></span>
                    </div>
                </div>
                <div class="info-card">
                    <div class="info-card-icon" style="background: rgba(48, 209, 88, 0.1); color: #30D158;">
                        <ion-icon name="calendar-outline"></ion-icon>
                    </div>
                    <div class="info-card-content">
                        <span class="info-label">Date & Time</span>
                        <span class="info-value"><%= data.Date %></span>
                    </div>
                </div>
                <div class="info-card">
                    <div class="info-card-icon" style="background: rgba(255, 149, 0, 0.1); color: #FF9500;">
                        <ion-icon name="cube-outline"></ion-icon>
                    </div>
                    <div class="info-card-content">
                        <span class="info-label">Total Items</span>
                        <span class="info-value"><%= totalQty %> units</span>
                    </div>
                </div>
                <div class="info-card">
                    <div class="info-card-icon" style="background: rgba(175, 82, 222, 0.1); color: #AF52DE;">
                        <ion-icon name="pricetag-outline"></ion-icon>
                    </div>
                    <div class="info-card-content">
                        <span class="info-label">Order ID</span>
                        <span class="info-value">#<%= data.bid %></span>
                    </div>
                </div>
            </div>

            <!-- Products Table -->
            <div class="modern-card">
                <div class="modern-card-header">
                    <div>
                        <h3 class="modern-card-title">Order Items</h3>
                        <p class="modern-card-subtitle"><%= data.products.length %> product(s) in this order</p>
                    </div>
                </div>

                <div style="overflow-x: auto;">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;">#</th>
                                <th style="width: 70px;">Image</th>
                                <th>Product</th>
                                <th>Size</th>
                                <th>Color</th>
                                <th>Price</th>
                                <th>Qty</th>
                                <th>Total</th>
                                <% if(data.status === "pending" && data.isCashier){ %>
                                    <th style="width: 80px;">Action</th>
                                <% } %>
                            </tr>
                        </thead>
                        <tbody>
                            <% for (let i = 0; i < data.products.length; i++) { %>
                                <tr>
                                    <td><span class="row-number"><%= i + 1 %></span></td>
                                    <td>
                                        <img src="/upload/images/<%= data.products[i].image %>" alt="<%= data.products[i].name %>" class="product-image">
                                    </td>
                                    <td><strong><%= data.products[i].name %></strong></td>
                                    <td><span class="size-badge"><%= data.products[i].size %></span></td>
                                    <td><%= data.products[i].colorName %></td>
                                    <td><%= data.products[i].price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") %> IQD</td>
                                    <td><span class="qty-badge"><%= data.products[i].qty %></span></td>
                                    <td><strong><%= data.products[i].total.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") %> IQD</strong></td>
                                    <% if(data.status === "pending" && data.isCashier){ %>
                                        <td>
                                            <button class="btn btn-danger btn-icon" onclick="returnItem('<%= data.id %>', '<%= data.products[i]._id %>')" title="Return Item">
                                                <ion-icon name="return-down-back-outline"></ion-icon>
                                            </button>
                                        </td>
                                    <% } %>
                                </tr>
                            <% } %>
                        </tbody>
                        <tfoot>
                            <tr class="subtotal-row">
                                <td colspan="<%= data.status === 'pending' && data.isCashier ? 7 : 6 %>" style="text-align: right; font-weight: 600;">Subtotal:</td>
                                <td colspan="2">
                                    <%= originalTotal.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") %> IQD
                                </td>
                            </tr>
                            <% if(hasDiscount) { %>
                                <tr class="discount-row">
                                    <td colspan="<%= data.status === 'pending' && data.isCashier ? 7 : 6 %>" style="text-align: right; font-weight: 600; color: var(--success-color);">
                                        <ion-icon name="pricetag-outline" style="vertical-align: middle; margin-right: 4px;"></ion-icon>
                                        Discount:
                                    </td>
                                    <td colspan="2" style="color: var(--success-color);">
                                        - <%= discountAmount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") %> IQD
                                    </td>
                                </tr>
                            <% } %>
                            <tr class="total-row">
                                <td colspan="<%= data.status === 'pending' && data.isCashier ? 7 : 6 %>" style="text-align: right; font-weight: 700; font-size: 18px;">TOTAL:</td>
                                <td colspan="2" style="font-size: 20px; font-weight: 700; color: var(--primary-color);">
                                    <%= data.total.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") %> IQD
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- Order Notes -->
            <% if(data.note) { %>
                <div class="modern-card">
                    <div class="modern-card-header" style="border-bottom: none; margin-bottom: 0; padding-bottom: 0;">
                        <div>
                            <h3 class="modern-card-title">
                                <ion-icon name="document-text-outline" style="margin-right: 8px;"></ion-icon>
                                Order Notes
                            </h3>
                        </div>
                    </div>
                    <div class="order-note">
                        <%= data.note %>
                    </div>
                </div>
            <% } %>
        </div>

        <!-- Sidebar -->
        <div class="order-sidebar">
            <!-- Order Summary Card -->
            <div class="modern-card summary-card">
                <div class="modern-card-header" style="border-bottom: none; margin-bottom: 0; padding-bottom: 0;">
                    <div>
                        <h3 class="modern-card-title">Order Summary</h3>
                    </div>
                </div>
                <div class="summary-content">
                    <div class="summary-row">
                        <span>Status</span>
                        <span class="order-status-badge <%= data.status === 'done' ? 'status-completed' : 'status-pending' %>" style="font-size: 12px; padding: 4px 10px;">
                            <%= data.status === 'done' ? 'Completed' : 'Pending' %>
                        </span>
                    </div>
                    <div class="summary-row">
                        <span>Items</span>
                        <span><%= data.products.length %> products</span>
                    </div>
                    <div class="summary-row">
                        <span>Quantity</span>
                        <span><%= totalQty %> units</span>
                    </div>
                    <div class="summary-row">
                        <span>Subtotal</span>
                        <span><%= originalTotal.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") %> IQD</span>
                    </div>
                    <% if(hasDiscount) { %>
                        <div class="summary-row" style="color: var(--success-color);">
                            <span>Discount</span>
                            <span>- <%= discountAmount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") %> IQD</span>
                        </div>
                    <% } %>
                    <div class="summary-divider"></div>
                    <div class="summary-row total">
                        <span>Total</span>
                        <span><%= data.total.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") %> IQD</span>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons-vertical">
                <button class="btn btn-primary action-btn-full" onclick="printReceipt()">
                    <ion-icon name="receipt-outline"></ion-icon>
                    <span>Print Receipt</span>
                </button>

                <a href="/localstore/orders/edit/<%= data.id %>" class="btn btn-secondary action-btn-full">
                    <ion-icon name="create-outline"></ion-icon>
                    <span>Edit Order</span>
                </a>

                <% if(data.status === "pending" && data.isCashier) { %>
                    <form action="/localstore/orders/confirm/<%= data.id %>?_method=PUT" method="post" style="width: 100%;">
                        <button type="submit" class="btn btn-success action-btn-full">
                            <ion-icon name="checkmark-circle-outline"></ion-icon>
                            <span>Confirm Order</span>
                        </button>
                    </form>
                <% } %>

                <button class="btn btn-danger action-btn-full" onclick="deleteOrder('<%= data.id %>')">
                    <ion-icon name="trash-outline"></ion-icon>
                    <span>Delete Order</span>
                </button>
            </div>

            <!-- Order Type Badge -->
            <div class="order-type-card">
                <ion-icon name="<%= data.isCashier ? 'storefront-outline' : 'globe-outline' %>"></ion-icon>
                <div>
                    <strong><%= data.isCashier ? 'POS Sale' : 'Online Order' %></strong>
                    <span><%= data.isCashier ? 'In-store transaction' : 'E-commerce order' %></span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Print Receipt Section (Hidden, used for printing) -->
<div id="printReceipt" class="print-receipt">
    <div class="receipt-content">
        <div class="receipt-header">
            <img src="/images/logo.svg" alt="Logo" class="receipt-logo">
            <h2>Abi Store</h2>
        </div>
        <div class="receipt-divider"></div>
        <div class="receipt-info">
            <h3>Receipt</h3>
            <p><strong>Order ID:</strong> <%= data.bid %></p>
            <p><strong>Cashier:</strong> <%= data.name %></p>
            <p><strong>Date:</strong> <%= data.Date %></p>
        </div>
        <div class="receipt-barcode">
            <svg id="receipt-barcode-svg"></svg>
        </div>
        <div class="receipt-divider"></div>
        <table class="receipt-table">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Size</th>
                    <th>Qty</th>
                    <th>Price</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                <% data.products.forEach(function(p) { %>
                    <tr>
                        <td><%= p.name %></td>
                        <td><%= p.size %></td>
                        <td><%= p.qty %></td>
                        <td><%= p.price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") %></td>
                        <td><%= p.total.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") %> IQD</td>
                    </tr>
                <% }); %>
            </tbody>
        </table>
        <div class="receipt-divider"></div>
        <div class="receipt-totals">
            <% if(hasDiscount) { %>
                <p>Subtotal: <%= originalTotal.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") %> IQD</p>
                <p>Discount: <%= discountAmount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") %> IQD</p>
                <div class="receipt-divider"></div>
            <% } %>
            <p class="receipt-total"><strong>Total: <%= data.total.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") %> IQD</strong></p>
        </div>
        <div class="receipt-divider"></div>
        <div class="receipt-footer">
            <p>شكرا لشرائكم من Abi Store</p>
            <p>اختياركم الافضل للملابس الطبية</p>
            <p>الموصل / مول عشتار - 9818 999 0770</p>
        </div>
        <div id="receipt-qrcode"></div>
    </div>
</div>

<style>
/* Order Layout */
.order-layout {
    display: grid;
    grid-template-columns: 1fr 340px;
    gap: 24px;
}

.order-main {
    min-width: 0;
}

.order-sidebar {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

/* Back Button */
.back-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border-radius: 10px;
    background: var(--background-primary);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    text-decoration: none;
    transition: var(--transition);
}

.back-btn:hover {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

/* Order Status Badge */
.order-status-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
}

.status-completed {
    background: rgba(48, 209, 88, 0.1);
    color: #30D158;
}

.status-pending {
    background: rgba(255, 149, 0, 0.1);
    color: #FF9500;
}

/* Header Actions */
.header-actions {
    display: flex;
    gap: 12px;
}

/* Order Info Grid */
.order-info-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 24px;
}

.info-card {
    background: white;
    border-radius: var(--border-radius);
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 16px;
    box-shadow: var(--shadow-light);
    border: 1px solid var(--border-color);
    transition: var(--transition);
}

.info-card:hover {
    box-shadow: var(--shadow-medium);
    transform: translateY(-2px);
}

.info-card-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
}

.info-card-content {
    display: flex;
    flex-direction: column;
}

.info-label {
    font-size: 12px;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
}

.info-value {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
}

/* Row Number */
.row-number {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    background: var(--background-primary);
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
}

/* Size & Qty Badges */
.size-badge {
    display: inline-block;
    padding: 4px 10px;
    background: var(--background-primary);
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
}

.qty-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 32px;
    height: 32px;
    padding: 0 10px;
    background: var(--primary-color);
    color: white;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
}

/* Table Footer Rows */
.modern-table tfoot tr {
    background: var(--background-primary);
}

.modern-table tfoot td {
    padding: 12px 16px;
    border-top: 1px solid var(--border-color);
}

.total-row {
    background: linear-gradient(135deg, #f0f4ff 0%, #e8f0fe 100%) !important;
}

.total-row td {
    border-top: 2px solid var(--primary-color) !important;
}

.discount-row td {
    background: rgba(48, 209, 88, 0.05);
}

/* Order Note */
.order-note {
    padding: 16px;
    background: var(--background-primary);
    border-radius: var(--border-radius);
    font-size: 14px;
    color: var(--text-secondary);
    line-height: 1.6;
    margin-top: 16px;
}

/* Summary Card */
.summary-card {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    color: white;
}

.summary-card:hover {
    transform: none;
}

.summary-card .modern-card-title {
    color: white;
}

.summary-content {
    padding-top: 16px;
}

.summary-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    font-size: 14px;
}

.summary-row.total {
    font-size: 22px;
    font-weight: 700;
    padding: 16px 0 8px;
}

.summary-divider {
    height: 1px;
    background: rgba(255, 255, 255, 0.1);
    margin: 8px 0;
}

/* Action Buttons */
.action-buttons-vertical {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.action-btn-full {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 14px 20px;
    font-size: 15px;
    font-weight: 500;
    border-radius: var(--border-radius);
    text-decoration: none;
    width: 100%;
}

/* Order Type Card */
.order-type-card {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    background: var(--background-primary);
    border-radius: var(--border-radius);
    border: 1px solid var(--border-color);
}

.order-type-card ion-icon {
    font-size: 32px;
    color: var(--primary-color);
}

.order-type-card div {
    display: flex;
    flex-direction: column;
}

.order-type-card strong {
    font-size: 14px;
    color: var(--text-primary);
}

.order-type-card span {
    font-size: 12px;
    color: var(--text-secondary);
}

/* Print Styles */
.print-receipt {
    display: none;
}

@media print {
    body * {
        visibility: hidden;
    }

    .print-receipt,
    .print-receipt * {
        visibility: visible;
    }

    .print-receipt {
        display: block;
        position: absolute;
        left: 0;
        top: 0;
        width: 80mm;
        padding: 10px;
        background: white;
    }

    .cashier-content,
    .cashier-sidebar,
    .cashier-navbar {
        display: none !important;
    }
}

.receipt-content {
    font-family: 'Ubuntu', sans-serif;
    font-size: 12px;
}

.receipt-header {
    text-align: center;
    margin-bottom: 10px;
}

.receipt-logo {
    width: 60px;
    height: auto;
}

.receipt-header h2 {
    font-size: 16px;
    margin: 5px 0;
}

.receipt-divider {
    border-top: 1px dashed #000;
    margin: 8px 0;
}

.receipt-info h3 {
    font-size: 14px;
    margin: 0 0 5px;
}

.receipt-info p {
    font-size: 10px;
    margin: 2px 0;
}

.receipt-barcode {
    text-align: center;
    margin: 10px 0;
}

.receipt-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 10px;
}

.receipt-table th,
.receipt-table td {
    border: 1px solid #000;
    padding: 4px;
    text-align: center;
}

.receipt-totals {
    font-size: 11px;
    margin: 10px 0;
}

.receipt-total {
    font-size: 14px;
}

.receipt-footer {
    text-align: center;
    font-family: 'Tajawal', sans-serif;
    font-size: 11px;
}

.receipt-footer p {
    margin: 3px 0;
}

#receipt-qrcode {
    display: flex;
    justify-content: center;
    margin-top: 10px;
}

/* Responsive */
@media (max-width: 1100px) {
    .order-layout {
        grid-template-columns: 1fr;
    }

    .order-info-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 600px) {
    .order-info-grid {
        grid-template-columns: 1fr;
    }

    .header-actions {
        flex-direction: column;
        width: 100%;
    }
}
</style>

<!-- Libraries for Receipt -->
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>

<script>
    function printReceipt() {
        // Generate barcode
        JsBarcode("#receipt-barcode-svg", "<%= data.bid %>", {
            format: "CODE128",
            lineColor: "#000",
            width: 2,
            height: 40,
            displayValue: false
        });

        // Generate QR code
        const qrContainer = document.getElementById("receipt-qrcode");
        qrContainer.innerHTML = '';
        new QRCode(qrContainer, {
            text: "https://www.instagram.com/abi.storre",
            width: 80,
            height: 80,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
        });

        // Print after a short delay
        setTimeout(() => {
            window.print();
        }, 300);
    }

    function returnItem(orderId, itemId) {
        Swal.fire({
            title: 'Return Item?',
            text: 'This will return the item to inventory and remove it from the order.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ff3b30',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Yes, return it'
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = `/localstore/orders/return/${orderId}/${itemId}`;
            }
        });
    }

    function deleteOrder(orderId) {
        Swal.fire({
            title: 'Delete Order?',
            text: 'This action cannot be undone. All items will be returned to inventory.',
            icon: 'error',
            showCancelButton: true,
            confirmButtonColor: '#ff3b30',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Yes, delete it'
        }).then((result) => {
            if (result.isConfirmed) {
                // Create and submit form
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/localstore/orders/delete/${orderId}?_method=DELETE`;
                document.body.appendChild(form);
                form.submit();
            }
        });
    }
</script>

<%- include("../layout/footer") -%>
