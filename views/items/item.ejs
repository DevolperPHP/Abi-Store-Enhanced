<%- include("../layout/navbar") -%>

    <% if(suc.length> 0){%>
        <script>
            var name = '<%= data.name %> - <%= data.size%>'
            Swal.fire({
                icon: 'success',
                title: 'Color added',
                text: `New color successfully added to ${name}`
            })
        </script>
        <%} %>

            <% if(edit_suc.length> 0){%>
                <script>
                    var name = '<%= data.name %> - <%= data.size%>'
                    Swal.fire({
                        icon: 'success',
                        title: 'Edit',
                        text: `The information of ${name} has been successfully edited`
                    })
                </script>
                <%} %>

                    <style>
                        .item-page {
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;

                            min-height: calc(100vh - 64px);
                            padding: 0;
                        }

                        .header-section {
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            border-radius: 20px;
                            padding: 60px 40px;
                            margin-bottom: 30px;
                            color: white;
                            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
                            position: relative;
                            overflow: hidden;
                        }

                        .header-section::before {
                            content: '';
                            position: absolute;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background: url("data:image/svg+xml,%3Csvg width='100' height='100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0h100v100H0z' fill='none'/%3E%3Cpath d='M50 30c11.046 0 20 8.954 20 20s-8.954 20-20 20-20-8.954-20-20 8.954-20 20-20zm0 40c6.627 0 12 5.373 12 12s-5.373 12-12 12-12-5.373-12-12 5.373-12 12-12z' fill='%23ffffff' fill-opacity='0.05'/%3E%3C/svg%3E");
                            opacity: 0.3;
                        }

                        .header-content {
                            position: relative;
                            z-index: 1;
                            display: flex;
                            align-items: center;
                            gap: 40px;
                        }

                        .header-image {
                            width: 200px;
                            height: 200px;
                            border-radius: 16px;
                            object-fit: cover;
                            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                            background: white;
                            padding: 10px;
                        }

                        .header-info h1 {
                            font-size: 48px;
                            font-weight: 700;
                            margin: 0 0 12px 0;
                            letter-spacing: -0.5px;
                        }

                        .header-info .subtitle {
                            font-size: 20px;
                            opacity: 0.9;
                            margin-bottom: 30px;
                        }

                        .price-display {
                            display: flex;
                            gap: 30px;
                            align-items: center;
                        }

                        .price-item {
                            display: flex;
                            flex-direction: column;
                        }

                        .price-label {
                            font-size: 14px;
                            opacity: 0.8;
                            margin-bottom: 4px;
                        }

                        .price-value {
                            font-size: 32px;
                            font-weight: 600;
                        }

                        .grid-container {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                            gap: 20px;
                            margin-bottom: 30px;
                        }

                        .info-card {
                            background: white;
                            border-radius: 16px;
                            padding: 30px;
                            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
                            transition: transform 0.2s, box-shadow 0.2s;
                        }

                        .info-card:hover {
                            transform: translateY(-4px);
                            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
                        }

                        .info-card h3 {
                            font-size: 18px;
                            font-weight: 600;
                            margin: 0 0 20px 0;
                            color: #1d1d1f;
                            display: flex;
                            align-items: center;
                            gap: 10px;
                        }

                        .info-card h3 ion-icon {
                            font-size: 22px;
                            color: #667eea;
                        }

                        .info-row {
                            display: flex;
                            justify-content: space-between;
                            padding: 12px 0;
                            border-bottom: 1px solid #f0f0f0;
                        }

                        .info-row:last-child {
                            border-bottom: none;
                        }

                        .info-label {
                            font-size: 14px;
                            color: #6e6e73;
                            font-weight: 500;
                        }

                        .info-value {
                            font-size: 15px;
                            color: #1d1d1f;
                            font-weight: 500;
                        }

                        .color-display {
                            display: flex;
                            align-items: center;
                            gap: 12px;
                        }

                        .color-circle {
                            width: 32px;
                            height: 32px;
                            border-radius: 50%;
                            border: 3px solid white;
                            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
                        }

                        .variants-section {
                            background: white;
                            border-radius: 16px;
                            padding: 30px;
                            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
                            margin-bottom: 30px;
                        }

                        .variants-section h3 {
                            font-size: 20px;
                            font-weight: 600;
                            margin: 0 0 24px 0;
                            color: #1d1d1f;
                        }

                        .variants-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
                            gap: 16px;
                        }

                        .variant-item {
                            aspect-ratio: 1;
                            border-radius: 12px;
                            cursor: pointer;
                            transition: transform 0.2s, box-shadow 0.2s;
                            border: 2px solid transparent;
                        }

                        .variant-item:hover {
                            transform: scale(1.05);
                            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                            border-color: #667eea;
                        }

                        .size-item {
                            background: #f5f5f7;
                            border-radius: 10px;
                            padding: 16px;
                            text-align: center;
                            cursor: pointer;
                            transition: all 0.2s;
                            font-weight: 500;
                            color: #1d1d1f;
                        }

                        .size-item:hover {
                            background: #667eea;
                            color: white;
                            transform: translateY(-2px);
                        }

                        .add-variant-btn {
                            background: #f5f5f7;
                            border: 2px dashed #d2d2d7;
                            border-radius: 12px;
                            padding: 16px;
                            cursor: pointer;
                            transition: all 0.2s;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 24px;
                            color: #6e6e73;
                        }

                        .add-variant-btn:hover {
                            background: #667eea;
                            border-color: #667eea;
                            color: white;
                        }

                        .chart-card {
                            background: white;
                            border-radius: 16px;
                            padding: 30px;
                            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
                            margin-bottom: 30px;
                        }

                        .chart-card h3 {
                            font-size: 20px;
                            font-weight: 600;
                            margin: 0 0 24px 0;
                            color: #1d1d1f;
                        }

                        .actions-section {
                            display: flex;
                            gap: 16px;
                            flex-wrap: wrap;
                            justify-content: center;
                            padding: 30px;
                            background: white;
                            border-radius: 16px;
                            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
                        }

                        .action-btn {
                            padding: 14px 32px;
                            border-radius: 12px;
                            border: none;
                            font-size: 16px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.3s;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                        }

                        .action-btn ion-icon {
                            font-size: 20px;
                        }

                        .btn-primary {
                            background: #667eea;
                            color: white;
                        }

                        .btn-primary:hover {
                            background: #5568d3;
                            transform: translateY(-2px);
                            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
                        }

                        .btn-success {
                            background: #0dbb7c;
                            color: white;
                        }

                        .btn-success:hover {
                            background: #0aa566;
                            transform: translateY(-2px);
                            box-shadow: 0 6px 20px rgba(13, 187, 124, 0.4);
                        }

                        .btn-warning {
                            background: #f59e0b;
                            color: white;
                        }

                        .btn-warning:hover {
                            background: #d97706;
                            transform: translateY(-2px);
                            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
                        }

                        .btn-danger {
                            background: #ef4444;
                            color: white;
                        }

                        .btn-danger:hover {
                            background: #dc2626;
                            transform: translateY(-2px);
                            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
                        }

                        .btn-purple {
                            background: #8b5cf6;
                            color: white;
                        }

                        .btn-purple:hover {
                            background: #7c3aed;
                            transform: translateY(-2px);
                            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
                        }

                        .description-card {
                            background: white;
                            border-radius: 16px;
                            padding: 30px;
                            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
                            margin-bottom: 30px;
                        }

                        .description-card h3 {
                            font-size: 20px;
                            font-weight: 600;
                            margin: 0 0 16px 0;
                            color: #1d1d1f;
                        }

                        .description-text {
                            font-size: 15px;
                            line-height: 1.8;
                            color: #6e6e73;
                            white-space: pre-wrap;
                        }

                        /* Analysis Modal Styles */
                        .analysis-modal {
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            z-index: 10000;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        }

                        .analysis-modal-overlay {
                            position: absolute;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background: rgba(0, 0, 0, 0.5);
                            backdrop-filter: blur(4px);
                        }

                        .analysis-modal-content {
                            position: relative;
                            background: white;
                            border-radius: 16px;
                            width: 90%;
                            max-width: 1200px;
                            max-height: 90vh;
                            overflow: hidden;
                            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                            animation: modalSlideIn 0.3s ease-out;
                        }

                        @keyframes modalSlideIn {
                            from {
                                opacity: 0;
                                transform: translateY(-50px);
                            }
                            to {
                                opacity: 1;
                                transform: translateY(0);
                            }
                        }

                        .analysis-modal-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: flex-start;
                            padding: 24px 32px;
                            border-bottom: 1px solid #e5e7eb;
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                        }

                        .analysis-header-info {
                            flex: 1;
                        }

                        .analysis-title {
                            margin: 0 0 8px 0;
                            font-size: 24px;
                            font-weight: 600;
                            display: flex;
                            align-items: center;
                            gap: 12px;
                        }

                        .analysis-title ion-icon {
                            font-size: 28px;
                        }

                        .analysis-subtitle {
                            margin: 0;
                            font-size: 14px;
                            opacity: 0.9;
                        }

                        .analysis-close-btn {
                            background: rgba(255, 255, 255, 0.2);
                            border: none;
                            width: 40px;
                            height: 40px;
                            border-radius: 50%;
                            color: white;
                            font-size: 24px;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            transition: all 0.2s;
                        }

                        .analysis-close-btn:hover {
                            background: rgba(255, 255, 255, 0.3);
                            transform: rotate(90deg);
                        }

                        .analysis-modal-body {
                            padding: 32px;
                            overflow-y: auto;
                            max-height: calc(90vh - 100px);
                        }

                        .analysis-summary-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                            gap: 20px;
                            margin-bottom: 32px;
                        }

                        .summary-card {
                            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                            border-radius: 12px;
                            padding: 20px;
                            display: flex;
                            align-items: center;
                            gap: 16px;
                            border: 1px solid #dee2e6;
                            transition: transform 0.2s;
                        }

                        .summary-card:hover {
                            transform: translateY(-2px);
                            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                        }

                        .summary-icon {
                            width: 48px;
                            height: 48px;
                            border-radius: 10px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 24px;
                        }

                        .summary-icon.sales {
                            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                            color: white;
                        }

                        .summary-icon.purchase {
                            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                            color: white;
                        }

                        .summary-icon.stock {
                            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
                            color: white;
                        }

                        .summary-icon.profit {
                            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                            color: white;
                        }

                        .summary-content {
                            flex: 1;
                        }

                        .summary-label {
                            font-size: 13px;
                            color: #6b7280;
                            font-weight: 500;
                            margin-bottom: 4px;
                        }

                        .summary-value {
                            font-size: 20px;
                            font-weight: 700;
                            color: #111827;
                            margin-bottom: 2px;
                        }

                        .summary-subtext {
                            font-size: 12px;
                            color: #9ca3af;
                        }

                        .analysis-metrics {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                            gap: 16px;
                            margin-bottom: 32px;
                            padding: 24px;
                            background: #f9fafb;
                            border-radius: 12px;
                        }

                        .metric-item {
                            display: flex;
                            flex-direction: column;
                            gap: 4px;
                        }

                        .metric-label {
                            font-size: 12px;
                            color: #6b7280;
                            font-weight: 500;
                        }

                        .metric-value {
                            font-size: 18px;
                            font-weight: 600;
                            color: #111827;
                        }

                        .analysis-transactions {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 24px;
                        }

                        .transactions-section {
                            background: #f9fafb;
                            border-radius: 12px;
                            padding: 20px;
                        }

                        .section-title {
                            margin: 0 0 16px 0;
                            font-size: 16px;
                            font-weight: 600;
                            color: #111827;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                        }

                        .section-title ion-icon {
                            font-size: 20px;
                            color: #6b7280;
                        }

                        .transactions-list {
                            display: flex;
                            flex-direction: column;
                            gap: 12px;
                        }

                        .transaction-item {
                            background: white;
                            border-radius: 8px;
                            padding: 12px;
                            display: grid;
                            grid-template-columns: 1fr auto auto;
                            gap: 12px;
                            align-items: center;
                            border: 1px solid #e5e7eb;
                        }

                        .transaction-info {
                            display: flex;
                            flex-direction: column;
                            gap: 4px;
                        }

                        .transaction-date {
                            font-size: 12px;
                            color: #6b7280;
                            font-weight: 500;
                        }

                        .transaction-details {
                            font-size: 13px;
                            color: #111827;
                        }

                        .transaction-qty {
                            font-size: 14px;
                            font-weight: 600;
                            color: #3b82f6;
                            white-space: nowrap;
                        }

                        .transaction-total {
                            font-size: 14px;
                            font-weight: 700;
                            color: #10b981;
                            white-space: nowrap;
                        }

                        .no-transactions {
                            text-align: center;
                            padding: 32px;
                            color: #9ca3af;
                            font-size: 14px;
                        }

                        @media (max-width: 768px) {
                            .header-content {
                                flex-direction: column;
                                text-align: center;
                            }

                            .header-info h1 {
                                font-size: 32px;
                            }

                            .price-display {
                                flex-direction: column;
                                gap: 16px;
                            }

                            .grid-container {
                                grid-template-columns: 1fr;
                            }

                            .analysis-modal-content {
                                width: 95%;
                                max-height: 95vh;
                            }

                            .analysis-modal-header {
                                padding: 20px 24px;
                            }

                            .analysis-modal-body {
                                padding: 24px;
                            }

                            .analysis-summary-grid {
                                grid-template-columns: 1fr;
                            }

                            .analysis-metrics {
                                grid-template-columns: 1fr;
                            }

                            .analysis-transactions {
                                grid-template-columns: 1fr;
                            }
                        }
                    </style>

                    <div class="dashboard-container">
                        <div class="item-page">
                        <!-- Header Section -->
                        <div class="header-section">
                            <div class="header-content">
                                <img src="/upload/images/<%= data.image%>" alt="<%= data.name%>" class="header-image">
                                <div class="header-info">
                                    <h1><%= data.name%></h1>
                                    <p class="subtitle"><%= data.category%> â€¢ <%= data.brand%></p>
                                    <div class="price-display">
                                        <div class="price-item">
                                            <span class="price-label">Price</span>
                                            <span class="price-value"><%= data.price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, "," )%> IQD</span>
                                        </div>
                                        <div class="price-item">
                                            <span class="price-label">Selling Price</span>
                                            <span class="price-value"><%= data.sell_price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, "," )%> IQD</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Product Details Grid -->
                        <div class="grid-container">
                            <div class="info-card">
                                <h3><ion-icon name="cube-outline"></ion-icon> Product Details</h3>
                                <div class="info-row">
                                    <span class="info-label">Size</span>
                                    <span class="info-value"><%= data.size%></span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Category</span>
                                    <span class="info-value"><%= data.category%></span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Brand</span>
                                    <span class="info-value"><%= data.brand%></span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Date Added</span>
                                    <span class="info-value"><%= data.Date%></span>
                                </div>
                            </div>

                            <div class="info-card">
                                <h3><ion-icon name="color-palette-outline"></ion-icon> Color & Style</h3>
                                <div class="info-row">
                                    <span class="info-label">Color</span>
                                    <span class="info-value">
                                        <div class="color-display">
                                            <div class="color-circle" style="background-color: <%= data.color%>"></div>
                                            <%= data.colorName || 'N/A' %>
                                        </div>
                                    </span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Color Code</span>
                                    <span class="info-value"><%= data.color%></span>
                                </div>
                            </div>

                            <div class="info-card">
                                <h3><ion-icon name="barcode-outline"></ion-icon> Inventory</h3>
                                <div class="info-row">
                                    <span class="info-label">Barcode</span>
                                    <span class="info-value"><%= data.barcode || 'N/A' %></span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Quantity</span>
                                    <span class="info-value"><%= data.qty%> units</span>
                                </div>
                                <% if(data.stock !== null && data.stock !== undefined) { %>
                                <div class="info-row">
                                    <span class="info-label">Store Stock</span>
                                    <span class="info-value"><%= data.stock%></span>
                                </div>
                                <% } %>
                            </div>
                        </div>

                        <!-- Description -->
                        <% if(data.des) { %>
                        <div class="description-card">
                            <h3><ion-icon name="document-text-outline"></ion-icon> Description</h3>
                            <p class="description-text"><%= data.des%></p>
                        </div>
                        <% } %>

                        <!-- Color Variants -->
                        <div class="variants-section">
                            <h3><ion-icon name="color-palette-outline"></ion-icon> Available Colors</h3>
                            <div class="variants-grid">
                                <% colors.forEach(color=> {%>
                                    <div class="variant-item" onclick="window.location.href='/items/get/<%= color.id%>'"
                                        style="background-color: <%= color.color%>" title="<%= color.colorName%>">
                                    </div>
                                <%}) %>
                                <div class="add-variant-btn" onclick="window.location.href='/items/add-color/<%= data.id%>'"
                                    title="Add Color">
                                    <ion-icon name="add"></ion-icon>
                                </div>
                            </div>
                        </div>

                        <!-- Size Variants -->
                        <div class="variants-section">
                            <h3><ion-icon name="resize-outline"></ion-icon> Available Sizes</h3>
                            <div class="variants-grid">
                                <% sizes.forEach(size=> {%>
                                    <div class="size-item" onclick="window.location.href='/items/get/<%= size.id%>'">
                                        <%= size.size%>
                                    </div>
                                <%}) %>
                                <div class="add-variant-btn" onclick="window.location.href='/items/add-size/<%= data.id%>'"
                                    title="Add Size">
                                    <ion-icon name="add"></ion-icon>
                                </div>
                            </div>
                        </div>

                        <!-- Performance Chart -->
                        <div class="chart-card">
                            <h3><ion-icon name="analytics-outline"></ion-icon> Performance Score</h3>
                            <canvas id="myChart" style="width:100%; max-width: 100%"></canvas>
                        </div>

                        <!-- Actions -->
                        <div class="actions-section">
                            <button class="action-btn btn-primary" onclick="window.location.href='/items/edit/<%= data.id%>'">
                                <ion-icon name="create-outline"></ion-icon>
                                Edit Item
                            </button>
                            <button class="action-btn btn-success" onclick="window.location.href='/items/barcode/<%= data.id%>'">
                                <ion-icon name="print-outline"></ion-icon>
                                Print Barcode
                            </button>
                            <button class="action-btn btn-warning" onclick="window.location.href='/items/edit/bulk/<%= data.id%>'">
                                <ion-icon name="layers-outline"></ion-icon>
                                Bulk Edit
                            </button>
                            <button class="action-btn btn-purple" onclick="analyzeProduct('<%= data.id%>')">
                                <ion-icon name="analytics-outline"></ion-icon>
                                Analysis
                            </button>
                            <button class="action-btn btn-danger" onclick="del()">
                                <ion-icon name="trash-outline"></ion-icon>
                                Delete Item
                            </button>
                        </div>
                            </div>
                        </div>
                    </div>
                    <script>
                        function del() {
                            Swal.fire({
                                icon: 'warning',
                                title: 'Are you sure ?!',
                                text: 'All data about the item will be lost and there is no way to get it back',
                                confirmButtonText: "Cancel",
                                html: `
                        <form action="/items/delete/<%= data.id%>?_method=DELETE" method="post">
                    <button style="margin-top: 10px; margin-left: auto;
                     margin-right: auto; border: none; border-radius: 5px;
                     padding: 10px; background-color: #d9534f;
                    color: #fff; font-size: 20px">Delete</button>
                </form>
                        `
                            })
                        }

                        // Analyze Product - Show transaction analysis
                        async function analyzeProduct(productId) {
                            try {
                                // Show loading state
                                Swal.fire({
                                    title: 'Loading Analysis...',
                                    html: '<div class="loading-spinner"><div class="spinner"></div></div>',
                                    showConfirmButton: false,
                                    allowOutsideClick: false,
                                    didOpen: () => {
                                        Swal.showLoading()
                                    }
                                });

                                // Fetch analysis data
                                const response = await fetch(`/items/analysis/${productId}`);
                                const data = await response.json();

                                if (!data.success) {
                                    throw new Error(data.message || 'Failed to load analysis');
                                }

                                // Close loading
                                Swal.close();

                                // Create and show modal with analysis
                                showAnalysisModal(data);

                            } catch (error) {
                                console.error('Analysis error:', error);
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    text: error.message || 'Failed to load analysis',
                                    confirmButtonColor: 'var(--primary-color)'
                                });
                            }
                        }

                        // Show Analysis Modal
                        function showAnalysisModal(data) {
                            const { product, summary, trends, recentTransactions } = data;

                            // Format numbers
                            const formatNumber = (num) => num.toLocaleString();
                            const formatCurrency = (num) => 'IQD ' + formatNumber(num);

                            // Create modal HTML
                            const modalHTML = `
                                <div class="analysis-modal" id="analysisModal">
                                    <div class="analysis-modal-overlay" onclick="closeAnalysisModal()"></div>
                                    <div class="analysis-modal-content">
                                        <div class="analysis-modal-header">
                                            <div class="analysis-header-info">
                                                <h2 class="analysis-title">
                                                    <ion-icon name="analytics-outline"></ion-icon>
                                                    Item Analysis
                                                </h2>
                                                <p class="analysis-subtitle">${product.name} - ${product.size} ${product.colorName ? '(' + product.colorName + ')' : ''}</p>
                                            </div>
                                            <button class="analysis-close-btn" onclick="closeAnalysisModal()">
                                                <ion-icon name="close-outline"></ion-icon>
                                            </button>
                                        </div>

                                        <div class="analysis-modal-body">
                                            <!-- Summary Cards -->
                                            <div class="analysis-summary-grid">
                                                <div class="summary-card">
                                                    <div class="summary-icon sales">
                                                        <ion-icon name="trending-up-outline"></ion-icon>
                                                    </div>
                                                    <div class="summary-content">
                                                        <div class="summary-label">Total Sold</div>
                                                        <div class="summary-value">${formatNumber(summary.totalSoldQty)} units</div>
                                                        <div class="summary-subtext">${formatCurrency(summary.totalSoldRevenue)} revenue</div>
                                                    </div>
                                                </div>

                                                <div class="summary-card">
                                                    <div class="summary-icon sales">
                                                        <ion-icon name="bag-add-outline"></ion-icon>
                                                    </div>
                                                    <div class="summary-content">
                                                        <div class="summary-label">Total Purchased</div>
                                                        <div class="summary-value">${formatNumber(summary.totalPurchasedQty)} units</div>
                                                        <div class="summary-subtext">${formatCurrency(summary.totalPurchasedCost)} cost</div>
                                                    </div>
                                                </div>

                                                <div class="summary-card">
                                                    <div class="summary-icon stock">
                                                        <ion-icon name="cube-outline"></ion-icon>
                                                    </div>
                                                    <div class="summary-content">
                                                        <div class="summary-label">Current Stock</div>
                                                        <div class="summary-value">${formatNumber(summary.currentStock)} units</div>
                                                        <div class="summary-subtext">${formatCurrency(summary.inventoryValue)} value</div>
                                                    </div>
                                                </div>

                                                <div class="summary-card">
                                                    <div class="summary-icon profit">
                                                        <ion-icon name="pricetags-outline"></ion-icon>
                                                    </div>
                                                    <div class="summary-content">
                                                        <div class="summary-label">Profit Margin</div>
                                                        <div class="summary-value">${summary.profitMargin}%</div>
                                                        <div class="summary-subtext">${formatCurrency(summary.avgSalePrice)} avg price</div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Metrics Grid -->
                                            <div class="analysis-metrics">
                                                <div class="metric-item">
                                                    <div class="metric-label">Average Cost</div>
                                                    <div class="metric-value">${formatCurrency(summary.avgCost)}</div>
                                                </div>
                                                <div class="metric-item">
                                                    <div class="metric-label">Average Sale Price</div>
                                                    <div class="metric-value">${formatCurrency(summary.avgSalePrice)}</div>
                                                </div>
                                                <div class="metric-item">
                                                    <div class="metric-label">Inventory Value</div>
                                                    <div class="metric-value">${formatCurrency(summary.inventoryValue)}</div>
                                                </div>
                                                <div class="metric-item">
                                                    <div class="metric-label">Potential Revenue</div>
                                                    <div class="metric-value">${formatCurrency(summary.potentialRevenue)}</div>
                                                </div>
                                                <div class="metric-item">
                                                    <div class="metric-label">Days of Inventory</div>
                                                    <div class="metric-value">${summary.daysOfInventory} days</div>
                                                </div>
                                                <div class="metric-item">
                                                    <div class="metric-label">Total Transactions</div>
                                                    <div class="metric-value">${formatNumber(summary.totalSalesTransactions + summary.totalPurchaseTransactions)}</div>
                                                </div>
                                            </div>

                                            <!-- Recent Transactions -->
                                            <div class="analysis-transactions">
                                                <div class="transactions-section">
                                                    <h3 class="section-title">
                                                        <ion-icon name="receipt-outline"></ion-icon>
                                                        Recent Sales (${recentTransactions.sales.length})
                                                    </h3>
                                                    <div class="transactions-list">
                                                        ${recentTransactions.sales.length > 0 ? recentTransactions.sales.map(sale => `
                                                            <div class="transaction-item">
                                                                <div class="transaction-info">
                                                                    <div class="transaction-date">${sale.date}</div>
                                                                    <div class="transaction-details">Order #${sale.bid} - ${sale.customer}</div>
                                                                </div>
                                                                <div class="transaction-qty">${formatNumber(sale.qty)} units</div>
                                                                <div class="transaction-total">${formatCurrency(sale.total)}</div>
                                                            </div>
                                                        `).join('') : '<div class="no-transactions">No sales transactions found</div>'}
                                                    </div>
                                                </div>

                                                <div class="transactions-section">
                                                    <h3 class="section-title">
                                                        <ion-icon name="bag-outline"></ion-icon>
                                                        Recent Purchases (${recentTransactions.purchases.length})
                                                    </h3>
                                                    <div class="transactions-list">
                                                        ${recentTransactions.purchases.length > 0 ? recentTransactions.purchases.map(purchase => `
                                                            <div class="transaction-item">
                                                                <div class="transaction-info">
                                                                    <div class="transaction-date">${purchase.date}</div>
                                                                    <div class="transaction-details">${purchase.trader}</div>
                                                                </div>
                                                                <div class="transaction-qty">${formatNumber(purchase.qty)} units</div>
                                                                <div class="transaction-total">${formatCurrency(purchase.cost)}</div>
                                                            </div>
                                                        `).join('') : '<div class="no-transactions">No purchase transactions found</div>'}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;

                            // Add modal to body
                            document.body.insertAdjacentHTML('beforeend', modalHTML);

                            // Prevent body scroll
                            document.body.style.overflow = 'hidden';
                        }

                        // Close Analysis Modal
                        function closeAnalysisModal() {
                            const modal = document.getElementById('analysisModal');
                            if (modal) {
                                modal.remove();
                                document.body.style.overflow = 'auto';
                            }
                        }

                        // Close modal on ESC key
                        document.addEventListener('keydown', (e) => {
                            if (e.key === 'Escape') {
                                closeAnalysisModal();
                            }
                        });
                    </script>

                    <script>
                        const getValuesOfLabels = "<%= scoreDate%>".split`,`
                        const xValues = getValuesOfLabels
                        const yValues = [<%= score %>];
                        var color = "<%= data.color%>"

                        new Chart("myChart", {
                            type: "line",
                            data: {
                                labels: xValues,
                                datasets: [{
                                    fill: false,
                                    lineTension: 0,
                                    backgroundColor: `${color}`,
                                    borderColor: "rgba(0,0,255,0.1)",
                                    data: yValues
                                }]
                            },
                            options: {
                                legend: { display: false },
                                scales: {
                                    yAxes: [{ ticks: { min: 1, max: 50 } }]
                                }
                            }
                        });
                    </script>
                    <%- include("../layout/footer") -%>